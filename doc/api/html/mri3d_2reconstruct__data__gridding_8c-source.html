<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1"/>
    <title>
      NFFT 3.0.2 API Reference - NFFT: reconstruct_data_gridding.c Source File
    </title>
    <link href="doxygen.css" rel="stylesheet" type="text/css"/>
    <link href="tabs.css" rel="stylesheet" type="text/css"/>
  </head>
  <body>
    <table>
      <tr>
        <td valign="top">
          <img src="images/logo.png" alt="NFFT Logo">
        </td>
        <td align="left" valign="bottom" width="100%">
          <H1nc>3.0.2 API Reference</H1nc>
        </td>
      </tr>
    </table>  
<!-- Generated by Doxygen 1.4.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a></div>
<div class="nav">
<a class="el" href="dir_000006.html">applications</a>&nbsp;/&nbsp;<a class="el" href="dir_000007.html">mri</a>&nbsp;/&nbsp;<a class="el" href="dir_000009.html">mri3d</a></div>
<h1>mri3d/reconstruct_data_gridding.c</h1><div class="fragment"><pre class="fragment">00001 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00002 <span class="preprocessor">#include &lt;math.h&gt;</span>
00003 <span class="preprocessor">#include "<a class="code" href="util_8h.html">util.h</a>"</span>
00004 <span class="preprocessor">#include "<a class="code" href="nfft3_8h.html">nfft3.h</a>"</span>
00005 
<a name="l00015"></a><a class="code" href="group__applications__mri3d__reconstruct__data__gridding.html#ga0">00015</a> <span class="keywordtype">void</span> <a class="code" href="group__applications__mri2d__reconstruct__data__2d.html#ga0">reconstruct</a>(<span class="keywordtype">char</span>* filename,<span class="keywordtype">int</span> N,<span class="keywordtype">int</span> M,<span class="keywordtype">int</span> Z, <span class="keywordtype">int</span> weight ,fftw_complex *mem)
00016 {
00017   <span class="keywordtype">int</span> j,k,z;               <span class="comment">/* some variables  */</span>
00018   <span class="keywordtype">double</span> weights;          <span class="comment">/* store one weight temporary */</span>
00019   <span class="keywordtype">double</span> tmp;              <span class="comment">/* tmp to read the obsolent z from the input file */</span>
00020   <span class="keywordtype">double</span> real,imag;        <span class="comment">/* to read the real and imag part of a complex number */</span>
00021   <a class="code" href="structnfft__plan.html">nfft_plan</a> my_plan;       <span class="comment">/* plan for the two dimensional nfft  */</span>
00022   <span class="keywordtype">int</span> my_N[2],my_n[2];     <span class="comment">/* to init the nfft */</span>
00023   FILE* fin;               <span class="comment">/* input file  */</span>
00024   FILE* fweight;           <span class="comment">/* input file for the weights */</span>
00025   
00026   <span class="comment">/* initialise my_plan */</span>
00027   my_N[0]=N; my_n[0]=ceil(N*1.2);
00028   my_N[1]=N; my_n[1]=ceil(N*1.2);
00029   <a class="code" href="group__nfft.html#ga9">nfft_init_guru</a>(&amp;my_plan, 2, my_N, M/Z, my_n, 6, <a class="code" href="group__nfft.html#ga16">PRE_PHI_HUT</a>| <a class="code" href="group__nfft.html#ga20">PRE_PSI</a>|
00030                         <a class="code" href="group__nfft.html#ga22">MALLOC_X</a>| <a class="code" href="group__nfft.html#ga23">MALLOC_F_HAT</a>| <a class="code" href="group__nfft.html#ga24">MALLOC_F</a>| 
00031                         <a class="code" href="group__nfft.html#ga26">FFTW_INIT</a>| <a class="code" href="group__nfft.html#ga25">FFT_OUT_OF_PLACE</a>,
00032                         FFTW_MEASURE| FFTW_DESTROY_INPUT);
00033   
00034   <span class="comment">/* precompute lin psi if set */</span>
00035   <span class="keywordflow">if</span>(my_plan.<a class="code" href="structnfft__plan.html#o12">nfft_flags</a> &amp; <a class="code" href="group__nfft.html#ga18">PRE_LIN_PSI</a>)
00036     <a class="code" href="group__nfft.html#ga13">nfft_precompute_lin_psi</a>(&amp;my_plan);
00037 
00038   fin=fopen(filename,<span class="stringliteral">"r"</span>);
00039 
00040   <span class="keywordflow">for</span>(z=0;z&lt;Z;z++) {
00041     fweight=fopen(<span class="stringliteral">"weights.dat"</span>,<span class="stringliteral">"r"</span>);
00042     <span class="keywordflow">for</span>(j=0;j&lt;my_plan.<a class="code" href="structnfft__plan.html#o1">M_total</a>;j++)
00043     {
00044       fscanf(fweight,<span class="stringliteral">"%le "</span>,&amp;weights);
00045       fscanf(fin,<span class="stringliteral">"%le %le %le %le %le"</span>,
00046              &amp;my_plan.<a class="code" href="structnfft__plan.html#o14">x</a>[2*j+0],&amp;my_plan.<a class="code" href="structnfft__plan.html#o14">x</a>[2*j+1],&amp;tmp,&amp;real,&amp;imag);
00047       my_plan.<a class="code" href="structnfft__plan.html#o3">f</a>[j] = real + I*imag;
00048       <span class="keywordflow">if</span>(weight)
00049         my_plan.<a class="code" href="structnfft__plan.html#o3">f</a>[j] = my_plan.<a class="code" href="structnfft__plan.html#o3">f</a>[j] * weights;
00050     } 
00051     fclose(fweight);
00052     
00053     <span class="comment">/* precompute psi if set just one time because the knots equal each slice */</span>
00054     <span class="keywordflow">if</span>(z==0 &amp;&amp; my_plan.<a class="code" href="structnfft__plan.html#o12">nfft_flags</a> &amp; <a class="code" href="group__nfft.html#ga20">PRE_PSI</a>)
00055       <a class="code" href="group__nfft.html#ga12">nfft_precompute_psi</a>(&amp;my_plan);
00056     
00057     <span class="comment">/* precompute full psi if set just one time because the knots equal each slice */</span>
00058     <span class="keywordflow">if</span>(z==0 &amp;&amp; my_plan.<a class="code" href="structnfft__plan.html#o12">nfft_flags</a> &amp; <a class="code" href="group__nfft.html#ga21">PRE_FULL_PSI</a>)
00059       <a class="code" href="group__nfft.html#ga11">nfft_precompute_full_psi</a>(&amp;my_plan);
00060     
00061     <span class="comment">/* compute the adjoint nfft */</span>
00062     <a class="code" href="group__nfft.html#ga3">nfft_adjoint</a>(&amp;my_plan);
00063 
00064     <span class="keywordflow">for</span>(k=0;k&lt;my_plan.<a class="code" href="structnfft__plan.html#o0">N_total</a>;k++) {
00065       <span class="comment">/* write every slice in the memory.</span>
00066 <span class="comment">      here we make an fftshift direct */</span>
00067       mem[(Z*N*N/2+z*N*N+ k)%(Z*N*N)] = my_plan.<a class="code" href="structnfft__plan.html#o2">f_hat</a>[k];
00068     }
00069   }
00070   fclose(fin);
00071   
00072   <a class="code" href="group__nfft.html#ga15">nfft_finalize</a>(&amp;my_plan);
00073 }
00074 
<a name="l00079"></a><a class="code" href="group__applications__mri3d__reconstruct__data__gridding.html#ga1">00079</a> <span class="keywordtype">void</span> <a class="code" href="group__applications__mri3d__reconstruct__data__1d2d.html#ga1">print</a>(<span class="keywordtype">int</span> N,<span class="keywordtype">int</span> M,<span class="keywordtype">int</span> Z, fftw_complex *mem)
00080 {
00081   <span class="keywordtype">int</span> i,j;
00082   FILE* fout_real;
00083   FILE* fout_imag;
00084   fout_real=fopen(<span class="stringliteral">"output_real.dat"</span>,<span class="stringliteral">"w"</span>);
00085   fout_imag=fopen(<span class="stringliteral">"output_imag.dat"</span>,<span class="stringliteral">"w"</span>);
00086 
00087   <span class="keywordflow">for</span>(i=0;i&lt;Z;i++) {
00088     <span class="keywordflow">for</span> (j=0;j&lt;N*N;j++) {
00089       fprintf(fout_real,<span class="stringliteral">"%le "</span>,creal(mem[(Z*N*N/2+i*N*N+ j)%(Z*N*N)]) /Z);
00090       fprintf(fout_imag,<span class="stringliteral">"%le "</span>,cimag(mem[(Z*N*N/2+i*N*N+ j)%(Z*N*N)]) /Z);
00091     }
00092     fprintf(fout_real,<span class="stringliteral">"\n"</span>);
00093     fprintf(fout_imag,<span class="stringliteral">"\n"</span>);
00094   }
00095 
00096   fclose(fout_real);
00097   fclose(fout_imag);
00098 }
00099 
00100 
00101 <span class="keywordtype">int</span> <a class="code" href="flags_8c.html#a6">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
00102 {
00103   fftw_complex *mem;
00104   fftw_plan plan;
00105   <span class="keywordtype">int</span> N,M,Z;  
00106 
00107   <span class="keywordflow">if</span> (argc &lt;= 6) {
00108     printf(<span class="stringliteral">"usage: ./reconstruct_data_gridding FILENAME N M Z ITER WEIGHTS\n"</span>);
00109     <span class="keywordflow">return</span> 1;
00110   }
00111 
00112   N=atoi(argv[2]);
00113   M=atoi(argv[3]);
00114   Z=atoi(argv[4]);
00115 
00116   <span class="comment">/* Allocate memory to hold every slice in memory after the</span>
00117 <span class="comment">  2D-infft */</span>
00118   mem = (fftw_complex*) fftw_malloc(<span class="keyword">sizeof</span>(fftw_complex) * atoi(argv[2]) * atoi(argv[2]) * atoi(argv[4]));
00119 
00120   <span class="comment">/* Create plan for the 1d-ifft */</span>
00121   plan = fftw_plan_many_dft(1, &amp;Z, N*N,
00122                                   mem, NULL,
00123                                   N*N, 1,
00124                                   mem, NULL,
00125                                   N*N,1 ,
00126                                   FFTW_BACKWARD, FFTW_MEASURE);
00127  
00128   <span class="comment">/* execute the 2d-nfft's */</span>
00129   <a class="code" href="group__applications__mri2d__reconstruct__data__2d.html#ga0">reconstruct</a>(argv[1],atoi(argv[2]),atoi(argv[3]),atoi(argv[4]),atoi(argv[6]),mem);
00130 
00131   <span class="comment">/* execute the 1d-fft's */</span>
00132   fftw_execute(plan);
00133   
00134   <span class="comment">/* write the memory back in files */</span>
00135   <a class="code" href="group__applications__mri3d__reconstruct__data__1d2d.html#ga1">print</a>(N,M,Z, mem);
00136 
00137   <span class="comment">/* free memory */</span>
00138   fftw_free(mem);
00139 
00140   <span class="keywordflow">return</span> 1;
00141 }
00142 <span class="comment">/* \} */</span>
</pre></div>    <hr size="1"/>
    Generated on 22 Jan 2007 by Doxygen 1.4.1
  </body>
</html>
