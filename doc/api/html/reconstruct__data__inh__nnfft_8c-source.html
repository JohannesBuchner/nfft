<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1"/>
    <title>
      NFFT 3.0.3 API Reference - NFFT: reconstruct_data_inh_nnfft.c Source File
    </title>
    <link href="doxygen.css" rel="stylesheet" type="text/css"/>
    <link href="tabs.css" rel="stylesheet" type="text/css"/>
  </head>
  <body>
    <table>
      <tr>
        <td valign="top">
          <img src="images/logo.png" alt="NFFT Logo">
        </td>
        <td align="left" valign="bottom" width="100%">
          <H1nc>3.0.3 API Reference</H1nc>
        </td>
      </tr>
    </table>  
<!-- Generated by Doxygen 1.4.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a></div>
<div class="nav">
<a class="el" href="dir_000006.html">applications</a>&nbsp;/&nbsp;<a class="el" href="dir_000007.html">mri</a>&nbsp;/&nbsp;<a class="el" href="dir_000008.html">mri2d</a></div>
<h1>reconstruct_data_inh_nnfft.c</h1><div class="fragment"><pre class="fragment">00001 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00002 <span class="preprocessor">#include &lt;math.h&gt;</span>
00003 <span class="preprocessor">#include &lt;limits.h&gt;</span>
00004 <span class="preprocessor">#include "<a class="code" href="util_8h.html">util.h</a>"</span>
00005 <span class="preprocessor">#include "<a class="code" href="nfft3_8h.html">nfft3.h</a>"</span>
00006 
<a name="l00016"></a><a class="code" href="group__applications__mri2d__construct__data__inh__nnfft.html#ga0">00016</a> <span class="keywordtype">void</span> <a class="code" href="group__applications__mri2d__reconstruct__data__2d.html#ga0">reconstruct</a>(<span class="keywordtype">char</span>* filename,<span class="keywordtype">int</span> N,<span class="keywordtype">int</span> M,<span class="keywordtype">int</span> iteration, <span class="keywordtype">int</span> weight)
00017 { 
00018   <span class="keywordtype">int</span> j,k,l;                    <span class="comment">/* some variables  */</span>
00019   <a class="code" href="structnnfft__plan.html">nnfft_plan</a> my_plan;            <span class="comment">/* plan for the two dimensional nfft  */</span>
00020   <a class="code" href="structinnfft__plan.html">innfft_plan</a> my_iplan;          <span class="comment">/* plan for the two dimensional infft */</span>
00021   FILE* fin;                    <span class="comment">/* input file                         */</span>
00022   FILE* finh;
00023   FILE* ftime;
00024   FILE* fout_real;              <span class="comment">/* output file                        */</span>
00025   FILE* fout_imag;              <span class="comment">/* output file                        */</span>
00026   <span class="keywordtype">int</span> my_N[3],my_n[3];          <span class="comment">/* to init the nfft */</span>
00027   <span class="keywordtype">double</span> t,epsilon=0.0000003;     <span class="comment">/* epsilon is a the break criterium for</span>
00028 <span class="comment">                                   the iteration */</span>
00029   <span class="keywordtype">unsigned</span> infft_flags = <a class="code" href="group__solver.html#ga37">CGNR</a> | <a class="code" href="group__solver.html#ga41">PRECOMPUTE_DAMP</a>; <span class="comment">/* flags for the infft*/</span>
00030   <span class="keywordtype">double</span> time,min_time,max_time,min_inh,max_inh;
00031   <span class="keywordtype">double</span> real,imag;
00032   <span class="keywordtype">double</span> *w;
00033 
00034   <span class="keywordtype">double</span> Ts;
00035   <span class="keywordtype">double</span> W;
00036   <span class="keywordtype">int</span> N3;
00037   <span class="keywordtype">int</span> m=2;
00038   <span class="keywordtype">double</span> sigma = 1.25;
00039   
00040   w = (<span class="keywordtype">double</span>*) malloc(N*N*<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
00041 
00042   ftime=fopen(<span class="stringliteral">"readout_time.dat"</span>,<span class="stringliteral">"r"</span>);
00043   finh=fopen(<span class="stringliteral">"inh.dat"</span>,<span class="stringliteral">"r"</span>);
00044 
00045   min_time=INT_MAX; max_time=INT_MIN;
00046   <span class="keywordflow">for</span>(j=0;j&lt;M;j++)
00047   {
00048     fscanf(ftime,<span class="stringliteral">"%le "</span>,&amp;time);
00049     <span class="keywordflow">if</span>(time&lt;min_time)
00050       min_time = time;
00051     <span class="keywordflow">if</span>(time&gt;max_time)
00052       max_time = time;
00053   }
00054 
00055   fclose(ftime);
00056   
00057   Ts=(min_time+max_time)/2.0;
00058 
00059   min_inh=INT_MAX; max_inh=INT_MIN;
00060   <span class="keywordflow">for</span>(j=0;j&lt;N*N;j++)
00061   {
00062     fscanf(finh,<span class="stringliteral">"%le "</span>,&amp;w[j]);
00063     <span class="keywordflow">if</span>(w[j]&lt;min_inh)
00064       min_inh = w[j];
00065     <span class="keywordflow">if</span>(w[j]&gt;max_inh)
00066       max_inh = w[j];
00067   }
00068   fclose(finh);
00069 
00070   N3=ceil((<a class="code" href="group__nfftutil.html#ga58">NFFT_MAX</a>(fabs(min_inh),fabs(max_inh))*(max_time-min_time)/2.0)*4);
00071 
00072 
00073   W=<a class="code" href="group__nfftutil.html#ga58">NFFT_MAX</a>(fabs(min_inh),fabs(max_inh))*2.0;
00074   
00075   fprintf(stderr,<span class="stringliteral">"3:  %i %e %e %e %e %e %e\n"</span>,N3,W,min_inh,max_inh,min_time,max_time,Ts);
00076 
00077   <span class="comment">/* initialise my_plan */</span>
00078   my_N[0]=N;my_n[0]=ceil(N*sigma);
00079   my_N[1]=N; my_n[1]=ceil(N*sigma);
00080   my_N[2]=N3; my_n[2]=ceil(N3*sigma);
00081   <a class="code" href="group__nnfft.html#ga1">nnfft_init_guru</a>(&amp;my_plan, 3, N*N, M, my_N,my_n,m,
00082         <a class="code" href="group__nfft.html#ga20">PRE_PSI</a>| <a class="code" href="group__nfft.html#ga16">PRE_PHI_HUT</a>| <a class="code" href="group__nfft.html#ga22">MALLOC_X</a>| <a class="code" href="group__nnfft.html#ga11">MALLOC_V</a>| <a class="code" href="group__nfft.html#ga23">MALLOC_F_HAT</a>| <a class="code" href="group__nfft.html#ga24">MALLOC_F</a> );
00083         
00084   <span class="comment">/* precompute lin psi if set */</span>
00085   <span class="keywordflow">if</span>(my_plan.<a class="code" href="structnnfft__plan.html#o15">nnfft_flags</a> &amp; <a class="code" href="group__nfft.html#ga18">PRE_LIN_PSI</a>)
00086     <a class="code" href="group__nnfft.html#ga6">nnfft_precompute_lin_psi</a>(&amp;my_plan);
00087   
00088   <span class="comment">/* set the flags for the infft*/</span>
00089   <span class="keywordflow">if</span> (weight)
00090     infft_flags = infft_flags | <a class="code" href="group__solver.html#ga40">PRECOMPUTE_WEIGHT</a>;
00091 
00092   <span class="comment">/* initialise my_iplan, advanced */</span>
00093   <a class="code" href="group__solver.html#ga16">innfft_init_advanced</a>(&amp;my_iplan,&amp;my_plan, infft_flags );
00094 
00095   <span class="comment">/* get the weights */</span>
00096   <span class="keywordflow">if</span>(my_iplan.<a class="code" href="structinnfft__plan.html#o1">flags</a> &amp; <a class="code" href="group__solver.html#ga40">PRECOMPUTE_WEIGHT</a>)
00097   {
00098     fin=fopen(<span class="stringliteral">"weights.dat"</span>,<span class="stringliteral">"r"</span>);
00099     <span class="keywordflow">for</span>(j=0;j&lt;my_plan.<a class="code" href="structnnfft__plan.html#o1">M_total</a>;j++)
00100     {
00101         fscanf(fin,<span class="stringliteral">"%le "</span>,&amp;my_iplan.<a class="code" href="structinnfft__plan.html#o2">w</a>[j]);
00102     }
00103     fclose(fin);
00104   }
00105   
00106   <span class="comment">/* get the damping factors */</span>
00107   <span class="keywordflow">if</span>(my_iplan.<a class="code" href="structinnfft__plan.html#o1">flags</a> &amp; <a class="code" href="group__solver.html#ga41">PRECOMPUTE_DAMP</a>)
00108   {
00109     <span class="keywordflow">for</span>(j=0;j&lt;N;j++){
00110       <span class="keywordflow">for</span>(k=0;k&lt;N;k++) {
00111         <span class="keywordtype">int</span> j2= j-N/2;
00112         <span class="keywordtype">int</span> k2= k-N/2;
00113         <span class="keywordtype">double</span> r=sqrt(j2*j2+k2*k2);
00114         <span class="keywordflow">if</span>(r&gt;(double) N/2) 
00115           my_iplan.<a class="code" href="structinnfft__plan.html#o3">w_hat</a>[j*N+k]=0.0;
00116         <span class="keywordflow">else</span>
00117           my_iplan.<a class="code" href="structinnfft__plan.html#o3">w_hat</a>[j*N+k]=1.0;
00118       }   
00119     }
00120   }
00121   
00122   <span class="comment">/* open the input file */</span>
00123   fin=fopen(filename,<span class="stringliteral">"r"</span>); 
00124   ftime=fopen(<span class="stringliteral">"readout_time.dat"</span>,<span class="stringliteral">"r"</span>);
00125 
00126   <span class="keywordflow">for</span>(j=0;j&lt;my_plan.<a class="code" href="structnnfft__plan.html#o1">M_total</a>;j++)
00127   {
00128     fscanf(fin,<span class="stringliteral">"%le %le %le %le "</span>,&amp;my_plan.<a class="code" href="structnnfft__plan.html#o17">x</a>[3*j+0],&amp;my_plan.<a class="code" href="structnnfft__plan.html#o17">x</a>[3*j+1],&amp;real,&amp;imag);
00129     my_iplan.<a class="code" href="structinnfft__plan.html#o4">y</a>[j]=real+I*imag;
00130     fscanf(ftime,<span class="stringliteral">"%le "</span>,&amp;my_plan.<a class="code" href="structnnfft__plan.html#o17">x</a>[3*j+2]);
00131 
00132     my_plan.<a class="code" href="structnnfft__plan.html#o17">x</a>[3*j+2] = (my_plan.<a class="code" href="structnnfft__plan.html#o17">x</a>[3*j+2]-Ts)*W/N3;
00133   }
00134 
00135   <span class="keywordflow">for</span>(j=0;j&lt;N;j++)
00136     { 
00137     <span class="keywordflow">for</span>(l=0;l&lt;N;l++)
00138       {
00139         my_plan.<a class="code" href="structnnfft__plan.html#o18">v</a>[3*(N*j+l)+0]=(((double) j) -(((double) N)/2.0))/((double) N);
00140         my_plan.<a class="code" href="structnnfft__plan.html#o18">v</a>[3*(N*j+l)+1]=(((double) l) -(((double) N)/2.0))/((double) N);
00141         my_plan.<a class="code" href="structnnfft__plan.html#o18">v</a>[3*(N*j+l)+2] = w[N*j+l]/W ;
00142       }
00143     }
00144  
00145   <span class="comment">/* precompute psi */</span>
00146   <span class="keywordflow">if</span>(my_plan.<a class="code" href="structnnfft__plan.html#o15">nnfft_flags</a> &amp; <a class="code" href="group__nfft.html#ga20">PRE_PSI</a>) {
00147     <a class="code" href="group__nnfft.html#ga7">nnfft_precompute_psi</a>(&amp;my_plan);
00148     <span class="keywordflow">if</span>(my_plan.<a class="code" href="structnnfft__plan.html#o15">nnfft_flags</a> &amp; <a class="code" href="group__nfft.html#ga21">PRE_FULL_PSI</a>)
00149       <a class="code" href="group__nnfft.html#ga8">nnfft_precompute_full_psi</a>(&amp;my_plan);
00150   }
00151   
00152   <span class="keywordflow">if</span>(my_plan.<a class="code" href="structnnfft__plan.html#o15">nnfft_flags</a> &amp; <a class="code" href="group__nfft.html#ga16">PRE_PHI_HUT</a>)
00153     <a class="code" href="group__nnfft.html#ga9">nnfft_precompute_phi_hut</a>(&amp;my_plan);
00154     
00155   <span class="comment">/* init some guess */</span>
00156   <span class="keywordflow">for</span>(k=0;k&lt;my_plan.<a class="code" href="structnnfft__plan.html#o0">N_total</a>;k++)
00157   {
00158     my_iplan.<a class="code" href="structinnfft__plan.html#o5">f_hat_iter</a>[k]=0.0;
00159   }
00160  
00161   t=<a class="code" href="group__nfftutil.html#ga0">nfft_second</a>();
00162   
00163   <span class="comment">/* inverse trafo */</span>
00164   <a class="code" href="group__solver.html#ga17">innfft_before_loop</a>(&amp;my_iplan);
00165   <span class="keywordflow">for</span>(l=0;l&lt;iteration;l++)
00166   {
00167     <span class="comment">/* break if dot_r_iter is smaller than epsilon*/</span>
00168     <span class="keywordflow">if</span>(my_iplan.<a class="code" href="structinnfft__plan.html#o12">dot_r_iter</a>&lt;epsilon)
00169     <span class="keywordflow">break</span>;
00170     fprintf(stderr,<span class="stringliteral">"%e,  %i of %i\n"</span>,sqrt(my_iplan.<a class="code" href="structinnfft__plan.html#o12">dot_r_iter</a>),
00171     l+1,iteration);
00172     <a class="code" href="group__solver.html#ga18">innfft_loop_one_step</a>(&amp;my_iplan);
00173   }
00174 
00175   t=<a class="code" href="group__nfftutil.html#ga0">nfft_second</a>()-t;
00176 <span class="preprocessor">#ifdef HAVE_TOTAL_USED_MEMORY</span>
00177 <span class="preprocessor"></span>fprintf(stderr,<span class="stringliteral">"time: %e seconds mem: %i \n"</span>,t,<a class="code" href="group__nfftutil.html#ga1">nfft_total_used_memory</a>());
00178 <span class="preprocessor">#else</span>
00179 <span class="preprocessor"></span>fprintf(stderr,<span class="stringliteral">"time: %e seconds mem: mallinfo not available\n"</span>,t);
00180 <span class="preprocessor">#endif</span>
00181 <span class="preprocessor"></span>
00182   fout_real=fopen(<span class="stringliteral">"output_real.dat"</span>,<span class="stringliteral">"w"</span>);
00183   fout_imag=fopen(<span class="stringliteral">"output_imag.dat"</span>,<span class="stringliteral">"w"</span>);
00184 
00185   <span class="keywordflow">for</span>(k=0;k&lt;my_plan.<a class="code" href="structnnfft__plan.html#o0">N_total</a>;k++) {
00186 
00187     my_iplan.<a class="code" href="structinnfft__plan.html#o5">f_hat_iter</a>[k]*=cexp(2.0*I*<a class="code" href="group__nfftutil.html#ga57">PI</a>*Ts*w[k]);
00188 
00189     fprintf(fout_real,<span class="stringliteral">"%le "</span>, creal(my_iplan.<a class="code" href="structinnfft__plan.html#o5">f_hat_iter</a>[k]));
00190     fprintf(fout_imag,<span class="stringliteral">"%le "</span>, cimag(my_iplan.<a class="code" href="structinnfft__plan.html#o5">f_hat_iter</a>[k]));
00191   }
00192   
00193 
00194   fclose(fout_real);
00195   fclose(fout_imag);
00196 
00197 
00198   <span class="comment">/* finalize the infft */</span>
00199   <a class="code" href="group__solver.html#ga19">innfft_finalize</a>(&amp;my_iplan);
00200   
00201   <span class="comment">/* finalize the nfft */</span>
00202   <a class="code" href="group__nnfft.html#ga10">nnfft_finalize</a>(&amp;my_plan);
00203 
00204   free(w);
00205 }
00206 
00207 <span class="keywordtype">int</span> <a class="code" href="flags_8c.html#a6">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
00208 {
00209   <span class="keywordflow">if</span> (argc &lt;= 5) {
00210     printf(<span class="stringliteral">"usage: ./reconstruct_data_inh_nnfft FILENAME N M ITER WEIGHTS\n"</span>);
00211     <span class="keywordflow">return</span> 1;
00212   }
00213   
00214   <a class="code" href="group__applications__mri2d__reconstruct__data__2d.html#ga0">reconstruct</a>(argv[1],atoi(argv[2]),atoi(argv[3]),atoi(argv[4]),atoi(argv[5]));
00215    
00216   <span class="keywordflow">return</span> 1;
00217 }
00218 <span class="comment">/* \} */</span>
</pre></div>    <hr size="1"/>
    Generated on 5 Feb 2007 by Doxygen 1.4.1
  </body>
</html>
