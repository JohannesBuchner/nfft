<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1"/>
    <title>
      NFFT 3.0.2 API Reference - NFFT: fields_fastsum.c Source File
    </title>
    <link href="doxygen.css" rel="stylesheet" type="text/css"/>
    <link href="tabs.css" rel="stylesheet" type="text/css"/>
  </head>
  <body>
    <table>
      <tr>
        <td valign="top">
          <img src="images/logo.png" alt="NFFT Logo">
        </td>
        <td align="left" valign="bottom" width="100%">
          <H1nc>3.0.2 API Reference</H1nc>
        </td>
      </tr>
    </table>  
<!-- Generated by Doxygen 1.4.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a></div>
<div class="nav">
<a class="el" href="dir_000006.html">applications</a>&nbsp;/&nbsp;<a class="el" href="dir_000017.html">potential</a></div>
<h1>fields_fastsum.c</h1><a href="fields__fastsum_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 
00008 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00009 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00010 <span class="preprocessor">#include &lt;string.h&gt;</span>
00011 <span class="preprocessor">#include &lt;complex.h&gt;</span>
00012 <span class="preprocessor">#include &lt;math.h&gt;</span>
00013 
00014 <span class="preprocessor">#include "<a class="code" href="fastsum_8h.html">fastsum.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="fields__fastsum_8h.html">fields_fastsum.h</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="kernels_8h.html">kernels.h</a>"</span>
00017 
<a name="l00019"></a><a class="code" href="fields__fastsum_8h.html#a2">00019</a> <span class="keywordtype">void</span> <a class="code" href="fields__fastsum_8c.html#a0">fields_fastsum_init</a>(<a class="code" href="structfields__fastsum__plan__.html">fields_fastsum_plan</a> *plan, <span class="keywordtype">int</span> N_total, <span class="keywordtype">unsigned</span> flags, <span class="keywordtype">int</span> nn, <span class="keywordtype">int</span> m, <span class="keywordtype">int</span> p, <span class="keywordtype">double</span> eps_I, <span class="keywordtype">double</span> eps_B) {
00020   <span class="keywordtype">double</span> *kernel_param;
00021 
00022   kernel_param = (<span class="keywordtype">double</span> *)malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
00023   kernel_param[0] = 0.0;
00024   plan-&gt;N_total = N_total;
00025   plan-&gt;q = (<span class="keywordtype">double</span> *)malloc(N_total*(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>)));
00026   plan-&gt;r = (<span class="keywordtype">double</span> *)malloc(3*N_total*(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>)));
00027   plan-&gt;E = (<span class="keywordtype">double</span> *)malloc(3*N_total*(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>)));
00028 
00029   <a class="code" href="group__applications__fastsum.html#ga13">fastsum_init_guru</a>(&amp;plan-&gt;fsum, 3, N_total, N_total, one_over_cube, kernel_param, flags, nn, m, p, eps_I, eps_B);
00030 }
00031 
<a name="l00033"></a><a class="code" href="fields__fastsum_8h.html#a3">00033</a> <span class="keywordtype">void</span> <a class="code" href="fields__fastsum_8c.html#a1">fields_fastsum_finalize</a>(<a class="code" href="structfields__fastsum__plan__.html">fields_fastsum_plan</a> *plan) {
00034   free(plan-&gt;fsum.kernel_param);
00035   <a class="code" href="group__applications__fastsum.html#ga14">fastsum_finalize</a>(&amp;plan-&gt;fsum);
00036 
00037   free(plan-&gt;E);
00038   free(plan-&gt;r);
00039   free(plan-&gt;q);
00040 }
00041 
<a name="l00043"></a><a class="code" href="fields__fastsum_8h.html#a4">00043</a> <span class="keywordtype">void</span> <a class="code" href="fields__fastsum_8c.html#a2">fields_fastsum_exact</a>(<a class="code" href="structfields__fastsum__plan__.html">fields_fastsum_plan</a> *plan) {
00044   <span class="keywordtype">int</span> j;
00045   <span class="keywordtype">int</span> l;
00046   <span class="keywordtype">double</span> s;
00047   <span class="keywordtype">double</span> E_pre = 1 / (4*<a class="code" href="group__nfftutil.html#ga57">PI</a>*<a class="code" href="fields__fastsum_8h.html#a0">EPSILON_0</a>);
00048   <span class="keywordtype">double</span> diff[3];
00049   <span class="keywordtype">double</span> sum[3];
00050 
00051   <span class="keywordflow">for</span>(j = 0; j &lt; plan-&gt;N_total; j++) {
00052     sum[0] = 0.0;
00053     sum[1] = 0.0;
00054     sum[2] = 0.0;
00055     <span class="keywordflow">for</span>(l = 0; l &lt; plan-&gt;N_total; l++) {
00056       <span class="keywordflow">if</span> (j == l) {
00057         <span class="keywordflow">continue</span>;
00058       }
00059       diff[0] = plan-&gt;r[j*3] - plan-&gt;r[l*3];
00060       diff[1] = plan-&gt;r[j*3+1] - plan-&gt;r[l*3+1];
00061       diff[2] = plan-&gt;r[j*3+2] - plan-&gt;r[l*3+2];
00062       s = diff[0] * diff[0] + diff[1] * diff[1] + diff[2] * diff[2];
00063       s = plan-&gt;q[l] / sqrt(s*s*s);
00064       sum[0] += s * diff[0];
00065       sum[1] += s * diff[1];
00066       sum[2] += s * diff[2];
00067     }
00068     plan-&gt;E[j*3] = E_pre * sum[0];
00069     plan-&gt;E[j*3+1] = E_pre * sum[1];
00070     plan-&gt;E[j*3+2] = E_pre * sum[2];
00071   }
00072 }
00073 
<a name="l00075"></a><a class="code" href="fields__fastsum_8h.html#a5">00075</a> <span class="keywordtype">void</span> <a class="code" href="fields__fastsum_8c.html#a3">fields_fastsum_simple</a>(<a class="code" href="structfields__fastsum__plan__.html">fields_fastsum_plan</a> *plan) {
00076   <span class="keywordtype">int</span> k;
00077   <span class="keywordtype">int</span> t;
00078   <span class="keywordtype">int</span> j;
00079   <span class="keywordtype">int</span> l;
00080   <span class="keywordtype">double</span> E_pre = 1 / (4*<a class="code" href="group__nfftutil.html#ga57">PI</a>*<a class="code" href="fields__fastsum_8h.html#a0">EPSILON_0</a>);
00081 
00082   <span class="keywordflow">for</span>(k = 0; k &lt; plan-&gt;N_total; k++) {
00083     <span class="keywordflow">for</span>(t = 0; t &lt; 3; t++) {
00084       plan-&gt;fsum.x[k*3+t] = plan-&gt;r[k*3+t];
00085       plan-&gt;fsum.y[k*3+t] = plan-&gt;r[k*3+t];
00086     }
00087     plan-&gt;fsum.alpha[k] = plan-&gt;q[k];
00088   }
00089 
00090   <span class="comment">/* steps 1, 2, 3, 6, 7 */</span>
00091   <a class="code" href="group__applications__fastsum.html#ga16">fastsum_precompute</a>(&amp;plan-&gt;fsum);
00092   <a class="code" href="group__applications__fastsum.html#ga17">fastsum_trafo</a>(&amp;plan-&gt;fsum);
00093   <span class="keywordflow">for</span>(j = 0; j &lt; plan-&gt;N_total; j++) {
00094     <span class="keywordflow">for</span>(t = 0; t &lt; 3; t++) {
00095       plan-&gt;E[j*3+t] = plan-&gt;r[j*3+t] * creal(plan-&gt;fsum.f[j]);
00096     }
00097   }
00098 
00099   <span class="keywordflow">for</span>(t = 0; t &lt; 3; t++) {
00100     <span class="keywordflow">for</span>(k = 0; k &lt; plan-&gt;N_total; k++) {
00101       <span class="keywordflow">for</span>(l = 0; l &lt; 3; l++) {
00102         plan-&gt;fsum.x[k*3+l] = plan-&gt;r[k*3+l];
00103         plan-&gt;fsum.y[k*3+l] = plan-&gt;r[k*3+l];
00104       }
00105     }
00106     <span class="keywordflow">for</span>(l = 0; l &lt; plan-&gt;N_total; l++) {
00107       plan-&gt;fsum.alpha[l] = plan-&gt;q[l] * plan-&gt;r[l*3+t];
00108     }
00109 
00110     <span class="comment">/* steps 1, 4, 5, 6, 7 */</span>
00111     <a class="code" href="group__applications__fastsum.html#ga16">fastsum_precompute</a>(&amp;plan-&gt;fsum);
00112     <a class="code" href="group__applications__fastsum.html#ga17">fastsum_trafo</a>(&amp;plan-&gt;fsum);
00113     <span class="keywordflow">for</span>(j = 0; j &lt; plan-&gt;N_total; j++) {
00114       plan-&gt;E[j*3+t] -= creal(plan-&gt;fsum.f[j]);
00115       plan-&gt;E[j*3+t] *= E_pre;
00116     }
00117   }
00118 }
00119 
<a name="l00121"></a><a class="code" href="fields__fastsum_8c.html#a4">00121</a> <span class="keywordtype">void</span> <a class="code" href="fields__fastsum_8c.html#a4">FieldsSearchTree</a>(<span class="keywordtype">double</span> *result, <span class="keywordtype">int</span> t, <span class="keywordtype">double</span> *x, complex *alpha, <span class="keywordtype">double</span> *xmin, <span class="keywordtype">double</span> *xmax, <span class="keywordtype">int</span> N, complex (*kernel)(<span class="keywordtype">double</span> , <span class="keywordtype">int</span> , <span class="keyword">const</span> <span class="keywordtype">double</span> *), <span class="keyword">const</span> <span class="keywordtype">double</span> *param, <span class="keywordtype">int</span> Ad, <span class="keywordtype">double</span> *Add, <span class="keywordtype">int</span> p, <span class="keywordtype">unsigned</span> flags)
00122 {
00123   <span class="keywordtype">int</span> m=N/2;
00124   <span class="keywordtype">double</span> Min=xmin[t], Max=xmax[t], Median=x[m*3+t];
00125   <span class="keywordtype">double</span> a=fabs(Max-Min)/2;
00126   <span class="keywordtype">double</span> r;
00127   <span class="keywordtype">double</span> kernel_value;
00128   <span class="keywordtype">double</span> q;
00129 
00130   <span class="keywordflow">if</span> (N==0)
00131     <span class="keywordflow">return</span>;
00132 
00133   <span class="keywordflow">if</span> (Min&gt;Median)
00134     <a class="code" href="fields__fastsum_8c.html#a4">FieldsSearchTree</a>(result, (t+1)%3,x+(m+1)*3,alpha+(m+1),xmin,xmax,N-m-1,kernel,param,Ad,Add,p,flags);
00135   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Max&lt;Median)
00136     <a class="code" href="fields__fastsum_8c.html#a4">FieldsSearchTree</a>(result, (t+1)%3,x,alpha,xmin,xmax,m,kernel,param,Ad,Add,p,flags);
00137   <span class="keywordflow">else</span>
00138   {
00139     <span class="keywordflow">if</span> (x[m*3]&gt;xmin[0] &amp;&amp; x[m*3]&lt;xmax[0] &amp;&amp; x[m*3+1]&gt;xmin[1] &amp;&amp; x[m*3+1]&lt;xmax[1] &amp;&amp; x[m*3+2]&gt;xmin[2] &amp;&amp; x[m*3+2]&lt;xmax[2])
00140     {
00141       r = (xmin[0]+a-x[m*3])*(xmin[0]+a-x[m*3]) + (xmin[1]+a-x[m*3+1])*(xmin[1]+a-x[m*3+1]) + (xmin[2]+a-x[m*3+2])*(xmin[2]+a-x[m*3+2]);
00142         <span class="comment">/* remember: xmin+a = y */</span>
00143       r=sqrt(r);
00144       <span class="keywordflow">if</span> (fabs(r)&lt;a)
00145       {
00146         kernel_value = kernel(r,0,param);
00147         <span class="keywordflow">if</span> (flags &amp; <a class="code" href="group__applications__fastsum.html#ga31">EXACT_NEARFIELD</a>)
00148           kernel_value -= <a class="code" href="group__applications__fastsum.html#ga4">regkern</a>(kernel,r,p,param,a,1.0/16.0);      <span class="comment">/* exact value  */</span>
00149         <span class="keywordflow">else</span>
00150           kernel_value -= <a class="code" href="group__applications__fastsum.html#ga8">kubintkern</a>(r,Add,Ad,a);                    <span class="comment">/* spline approximation */</span>
00151 
00152         q = creal(alpha[m]);
00153 
00154         result[0] += (xmin[0]+a-x[m*3])*q*kernel_value;              <span class="comment">/* alpha*(kern-regkern) */</span>
00155         result[1] += (xmin[1]+a-x[m*3+1])*q*kernel_value;
00156         result[2] += (xmin[2]+a-x[m*3+2])*q*kernel_value;
00157       }
00158     }
00159     <a class="code" href="fields__fastsum_8c.html#a4">FieldsSearchTree</a>(result,(t+1)%3,x+(m+1)*3,alpha+(m+1),xmin,xmax,N-m-1,kernel,param,Ad,Add,p,flags);
00160     <a class="code" href="fields__fastsum_8c.html#a4">FieldsSearchTree</a>(result,(t+1)%3,x,alpha,xmin,xmax,m,kernel,param,Ad,Add,p,flags);
00161   }
00162 }
00163 
<a name="l00165"></a><a class="code" href="fields__fastsum_8h.html#a6">00165</a> <span class="keywordtype">void</span> <a class="code" href="fields__fastsum_8c.html#a5">fields_fastsum_precompute</a>(<a class="code" href="structfields__fastsum__plan__.html">fields_fastsum_plan</a> *plan) {
00166   <span class="keywordtype">int</span> k;
00167   <span class="keywordtype">int</span> t;
00168   <span class="keywordtype">double</span> time;
00169 
00170   time=<a class="code" href="group__nfftutil.html#ga0">nfft_second</a>();
00171 
00172   <span class="keywordflow">for</span>(k = 0; k &lt; plan-&gt;N_total; k++) {
00173     <span class="keywordflow">for</span>(t = 0; t &lt; 3; t++) {
00174       plan-&gt;fsum.x[k*3+t] = plan-&gt;r[k*3+t];
00175       plan-&gt;fsum.y[k*3+t] = plan-&gt;r[k*3+t];
00176     }
00177     plan-&gt;fsum.alpha[k] = plan-&gt;q[k];
00178   }
00179 
00180   <a class="code" href="group__applications__fastsum.html#ga16">fastsum_precompute</a>(&amp;plan-&gt;fsum);
00181 }
00182 
00183 
<a name="l00185"></a><a class="code" href="fields__fastsum_8h.html#a7">00185</a> <span class="keywordtype">void</span> <a class="code" href="fields__fastsum_8c.html#a6">fields_fastsum_trafo</a>(<a class="code" href="structfields__fastsum__plan__.html">fields_fastsum_plan</a> *plan) {
00186   <span class="keywordtype">int</span> j,k,t;
00187   <span class="keywordtype">double</span> E_pre = 1 / (4*<a class="code" href="group__nfftutil.html#ga57">PI</a>*<a class="code" href="fields__fastsum_8h.html#a0">EPSILON_0</a>);
00188 
00190   <span class="keywordtype">double</span> ymin[3], ymax[3];
00191 
00193   <a class="code" href="group__nfft.html#ga3">nfft_adjoint</a>(&amp;(plan-&gt;fsum.mv1));
00194 
00196   <span class="keywordflow">for</span> (k=0; k&lt;plan-&gt;fsum.mv2.N_total; k++)
00197     plan-&gt;fsum.mv2.f_hat[k] = plan-&gt;fsum.b[k] * plan-&gt;fsum.mv1.f_hat[k];
00198 
00200   <a class="code" href="group__nfft.html#ga2">nfft_trafo</a>(&amp;(plan-&gt;fsum.mv2));
00201   <span class="keywordflow">for</span>(j = 0; j &lt; plan-&gt;N_total; j++) {
00202     plan-&gt;E[j*3] = plan-&gt;r[j*3] * creal(plan-&gt;fsum.mv2.f[j]);
00203     plan-&gt;E[j*3+1] = plan-&gt;r[j*3+1] * creal(plan-&gt;fsum.mv2.f[j]);
00204     plan-&gt;E[j*3+2] = plan-&gt;r[j*3+2] * creal(plan-&gt;fsum.mv2.f[j]);
00205   }
00206 
00207   <span class="keywordflow">for</span>(t = 0; t &lt; 3; t++) {
00209     <span class="keywordflow">for</span>(k = 0; k &lt; plan-&gt;N_total; k++)
00210       plan-&gt;fsum.mv1.f[k] = plan-&gt;fsum.alpha[k] * plan-&gt;fsum.x[3*k+t];
00211     <a class="code" href="group__nfft.html#ga3">nfft_adjoint</a>(&amp;(plan-&gt;fsum.mv1));
00212 
00214     <span class="keywordflow">for</span> (k=0; k&lt;plan-&gt;fsum.mv2.N_total; k++)
00215       plan-&gt;fsum.mv2.f_hat[k] = plan-&gt;fsum.b[k] * plan-&gt;fsum.mv1.f_hat[k];
00216 
00218     <a class="code" href="group__nfft.html#ga2">nfft_trafo</a>(&amp;(plan-&gt;fsum.mv2));
00219     <span class="keywordflow">for</span>(j = 0; j &lt; plan-&gt;N_total; j++)
00220       plan-&gt;E[j*3+t] -= creal(plan-&gt;fsum.mv2.f[j]);
00221   }
00222 
00224   <span class="keywordflow">for</span> (j=0; j&lt;plan-&gt;fsum.M_total; j++)
00225   {
00226     ymin[0] = plan-&gt;fsum.y[3*j] - plan-&gt;fsum.eps_I;
00227     ymax[0] = plan-&gt;fsum.y[3*j] + plan-&gt;fsum.eps_I;
00228     ymin[1] = plan-&gt;fsum.y[3*j+1] - plan-&gt;fsum.eps_I;
00229     ymax[1] = plan-&gt;fsum.y[3*j+1] + plan-&gt;fsum.eps_I;
00230     ymin[2] = plan-&gt;fsum.y[3*j+2] - plan-&gt;fsum.eps_I;
00231     ymax[2] = plan-&gt;fsum.y[3*j+2] + plan-&gt;fsum.eps_I;
00232 
00233     <a class="code" href="fields__fastsum_8c.html#a4">FieldsSearchTree</a>(plan-&gt;E+3*j, 0, plan-&gt;fsum.x, plan-&gt;fsum.alpha, ymin, ymax, plan-&gt;fsum.N_total, plan-&gt;fsum.kernel, plan-&gt;fsum.kernel_param, plan-&gt;fsum.Ad, plan-&gt;fsum.Add, plan-&gt;fsum.p, plan-&gt;fsum.flags);
00234 
00235     plan-&gt;E[j*3] *= E_pre;
00236     plan-&gt;E[j*3+1] *= E_pre;
00237     plan-&gt;E[j*3+2] *= E_pre;
00238   }
00239 }
00240 
</pre></div>    <hr size="1"/>
    Generated on 22 Jan 2007 by Doxygen 1.4.1
  </body>
</html>
