<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1"/>
    <title>
      NFFT 3.0.2 API Reference - NFFT: inverse_radon.c Source File
    </title>
    <link href="doxygen.css" rel="stylesheet" type="text/css"/>
    <link href="tabs.css" rel="stylesheet" type="text/css"/>
  </head>
  <body>
    <table>
      <tr>
        <td valign="top">
          <img src="images/logo.png" alt="NFFT Logo">
        </td>
        <td align="left" valign="bottom" width="100%">
          <H1nc>3.0.2 API Reference</H1nc>
        </td>
      </tr>
    </table>  
<!-- Generated by Doxygen 1.4.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a></div>
<div class="nav">
<a class="el" href="dir_000006.html">applications</a>&nbsp;/&nbsp;<a class="el" href="dir_000022.html">radon</a></div>
<h1>inverse_radon.c</h1><a href="inverse__radon_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 
00019 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00020 <span class="preprocessor">#include &lt;math.h&gt;</span>
00021 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00022 <span class="preprocessor">#include &lt;string.h&gt;</span>
00023 
00024 <span class="preprocessor">#include "<a class="code" href="util_8h.html">util.h</a>"</span>
00025 <span class="preprocessor">#include "<a class="code" href="nfft3_8h.html">nfft3.h</a>"</span>
00026 
00028 <span class="comment">/*#define KERNEL(r) 1.0 */</span>
<a name="l00029"></a><a class="code" href="inverse__radon_8c.html#a0">00029</a> <span class="preprocessor">#define KERNEL(r) (1.0-fabs((double)(r))/((double)R/2))</span>
00030 <span class="preprocessor"></span>
<a name="l00034"></a><a class="code" href="inverse__radon_8c.html#a1">00034</a> <span class="keywordtype">int</span> <a class="code" href="group__applications__polarFFT__polar.html#ga0">polar_grid</a>(<span class="keywordtype">int</span> T, <span class="keywordtype">int</span> R, <span class="keywordtype">double</span> *x, <span class="keywordtype">double</span> *w)
00035 {
00036   <span class="keywordtype">int</span> t, r;
00037   <span class="keywordtype">double</span> W=(double)T*(((double)R/2.0)*((double)R/2.0)+1.0/4.0);
00038 
00039   <span class="keywordflow">for</span>(t=-T/2; t&lt;T/2; t++)
00040   {
00041     <span class="keywordflow">for</span>(r=-R/2; r&lt;R/2; r++)
00042     {
00043       x[2*((t+T/2)*R+(r+R/2))+0] = (double)r/R*cos(<a class="code" href="group__nfftutil.html#ga57">PI</a>*t/T);
00044       x[2*((t+T/2)*R+(r+R/2))+1] = (double)r/R*sin(<a class="code" href="group__nfftutil.html#ga57">PI</a>*t/T);
00045       <span class="keywordflow">if</span> (r==0)
00046         w[(t+T/2)*R+(r+R/2)] = 1.0/4.0/W;
00047       <span class="keywordflow">else</span>
00048         w[(t+T/2)*R+(r+R/2)] = fabs((<span class="keywordtype">double</span>)r)/W;
00049     }
00050   }
00051 
00052   <span class="keywordflow">return</span> 0;
00053 }
00054 
<a name="l00058"></a><a class="code" href="inverse__radon_8c.html#a2">00058</a> <span class="keywordtype">int</span> <a class="code" href="group__applications__polarFFT__linogramm.html#ga1">linogram_grid</a>(<span class="keywordtype">int</span> T, <span class="keywordtype">int</span> R, <span class="keywordtype">double</span> *x, <span class="keywordtype">double</span> *w)
00059 {
00060   <span class="keywordtype">int</span> t, r;
00061   <span class="keywordtype">double</span> W=(double)T*(((double)R/2.0)*((double)R/2.0)+1.0/4.0);
00062 
00063   <span class="keywordflow">for</span>(t=-T/2; t&lt;T/2; t++)
00064   {
00065     <span class="keywordflow">for</span>(r=-R/2; r&lt;R/2; r++)
00066     {
00067       <span class="keywordflow">if</span>(t&lt;0)
00068       {
00069         x[2*((t+T/2)*R+(r+R/2))+0] = (double)r/R;
00070         x[2*((t+T/2)*R+(r+R/2))+1] = (double)4*(t+T/4)/T*r/R;
00071       }
00072       <span class="keywordflow">else</span>
00073       {
00074         x[2*((t+T/2)*R+(r+R/2))+0] = -(double)4*(t-T/4)/T*r/R;
00075         x[2*((t+T/2)*R+(r+R/2))+1] = (double)r/R;
00076       }
00077       <span class="keywordflow">if</span> (r==0)
00078         w[(t+T/2)*R+(r+R/2)] = 1.0/4.0/W;
00079       <span class="keywordflow">else</span>
00080         w[(t+T/2)*R+(r+R/2)] = fabs((<span class="keywordtype">double</span>)r)/W;
00081     }
00082   }
00083 
00084   <span class="keywordflow">return</span> 0;
00085 }
00086 
<a name="l00091"></a><a class="code" href="inverse__radon_8c.html#a3">00091</a> <span class="keywordtype">int</span> <a class="code" href="inverse__radon_8c.html#a3">Inverse_Radon_trafo</a>(<span class="keywordtype">int</span> (*gridfcn)(), <span class="keywordtype">int</span> T, <span class="keywordtype">int</span> R, <span class="keywordtype">double</span> *Rf, <span class="keywordtype">int</span> NN, <span class="keywordtype">double</span> *f, <span class="keywordtype">int</span> max_i)
00092 {
00093   <span class="keywordtype">int</span> j,k;                              
00094   <a class="code" href="structnfft__plan.html">nfft_plan</a> my_nfft_plan;               
00095   <a class="code" href="structinfft__plan.html">infft_plan</a> my_infft_plan;             
00097   fftw_complex *<a class="code" href="group__applications__mri3d__construct__data__1d2d.html#ga1">fft</a>;                    
00098   fftw_plan my_fftw_plan;               
00100   <span class="keywordtype">int</span> t,r;                              
00101   <span class="keywordtype">double</span> *x, *w;                        
00102   <span class="keywordtype">int</span> l;                                
00104   <span class="keywordtype">int</span> N[2],n[2];
00105   <span class="keywordtype">int</span> M=T*R;
00106 
00107   N[0]=NN; n[0]=2*N[0];
00108   N[1]=NN; n[1]=2*N[1];
00109 
00110   <a class="code" href="group__applications__mri3d__construct__data__1d2d.html#ga1">fft</a> = (fftw_complex *)fftw_malloc(R*<span class="keyword">sizeof</span>(fftw_complex));
00111   my_fftw_plan = fftw_plan_dft_1d(R,<a class="code" href="group__applications__mri3d__construct__data__1d2d.html#ga1">fft</a>,<a class="code" href="group__applications__mri3d__construct__data__1d2d.html#ga1">fft</a>,FFTW_FORWARD,FFTW_MEASURE);
00112 
00113   x = (<span class="keywordtype">double</span> *)malloc(2*T*R*(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>)));
00114   <span class="keywordflow">if</span> (x==NULL)
00115     <span class="keywordflow">return</span> -1;
00116 
00117   w = (<span class="keywordtype">double</span> *)malloc(T*R*(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>)));
00118   <span class="keywordflow">if</span> (w==NULL)
00119     <span class="keywordflow">return</span> -1;
00120 
00122   <a class="code" href="group__nfft.html#ga9">nfft_init_guru</a>(&amp;my_nfft_plan, 2, N, M, n, 4,
00123                   <a class="code" href="group__nfft.html#ga16">PRE_PHI_HUT</a>| <a class="code" href="group__nfft.html#ga20">PRE_PSI</a>| <a class="code" href="group__nfft.html#ga22">MALLOC_X</a> | <a class="code" href="group__nfft.html#ga23">MALLOC_F_HAT</a>| <a class="code" href="group__nfft.html#ga24">MALLOC_F</a>| <a class="code" href="group__nfft.html#ga26">FFTW_INIT</a> | <a class="code" href="group__nfft.html#ga25">FFT_OUT_OF_PLACE</a>,
00124                   FFTW_MEASURE| FFTW_DESTROY_INPUT);
00125 
00127   <a class="code" href="group__solver.html#ga1">infft_init_advanced</a>(&amp;my_infft_plan,&amp;my_nfft_plan, <a class="code" href="group__solver.html#ga37">CGNR</a> | <a class="code" href="group__solver.html#ga40">PRECOMPUTE_WEIGHT</a>);
00128 
00130   gridfcn(T,R,x,w);
00131   <span class="keywordflow">for</span>(j=0;j&lt;my_nfft_plan.<a class="code" href="structnfft__plan.html#o1">M_total</a>;j++)
00132   {
00133     my_nfft_plan.<a class="code" href="structnfft__plan.html#o14">x</a>[2*j+0] = x[2*j+0];
00134     my_nfft_plan.<a class="code" href="structnfft__plan.html#o14">x</a>[2*j+1] = x[2*j+1];
00135     <span class="keywordflow">if</span> (j%R)
00136       my_infft_plan.<a class="code" href="structinfft__plan.html#o2">w</a>[j]    = w[j];
00137     <span class="keywordflow">else</span>
00138       my_infft_plan.<a class="code" href="structinfft__plan.html#o2">w</a>[j]    = 0.0;
00139   }
00140 
00142   <span class="keywordflow">if</span>(my_nfft_plan.<a class="code" href="structnfft__plan.html#o12">nfft_flags</a> &amp; <a class="code" href="group__nfft.html#ga18">PRE_LIN_PSI</a>)
00143     <a class="code" href="group__nfft.html#ga13">nfft_precompute_lin_psi</a>(&amp;my_nfft_plan);
00144 
00145   <span class="keywordflow">if</span>(my_nfft_plan.<a class="code" href="structnfft__plan.html#o12">nfft_flags</a> &amp; <a class="code" href="group__nfft.html#ga20">PRE_PSI</a>)
00146     <a class="code" href="group__nfft.html#ga12">nfft_precompute_psi</a>(&amp;my_nfft_plan);
00147 
00148   <span class="keywordflow">if</span>(my_nfft_plan.<a class="code" href="structnfft__plan.html#o12">nfft_flags</a> &amp; <a class="code" href="group__nfft.html#ga21">PRE_FULL_PSI</a>)
00149     <a class="code" href="group__nfft.html#ga11">nfft_precompute_full_psi</a>(&amp;my_nfft_plan);
00150 
00152   <span class="keywordflow">for</span>(t=0; t&lt;T; t++)
00153   {
00154 <span class="comment">/*    for(r=0; r&lt;R/2; r++)</span>
00155 <span class="comment">       fft[r] = cexp(I*PI*r)*Rf[t*R+(r+R/2)];</span>
00156 <span class="comment">      for(r=0; r&lt;R/2; r++)</span>
00157 <span class="comment">       fft[r+R/2] = cexp(I*PI*r)*Rf[t*R+r];</span>
00158 <span class="comment"> */</span>
00159 
00160     <span class="keywordflow">for</span>(r=0; r&lt;R; r++)
00161       <a class="code" href="group__applications__mri3d__construct__data__1d2d.html#ga1">fft</a>[r] = Rf[t*R+r] + I*0.0;
00162 
00163     <a class="code" href="group__nfftutil.html#ga36">nfft_fftshift_complex</a>(<a class="code" href="group__applications__mri3d__construct__data__1d2d.html#ga1">fft</a>, 1, &amp;R);
00164     fftw_execute(my_fftw_plan);
00165     <a class="code" href="group__nfftutil.html#ga36">nfft_fftshift_complex</a>(<a class="code" href="group__applications__mri3d__construct__data__1d2d.html#ga1">fft</a>, 1, &amp;R);
00166 
00167     my_infft_plan.<a class="code" href="structinfft__plan.html#o4">y</a>[t*R] = 0.0;
00168     <span class="keywordflow">for</span>(r=-R/2+1; r&lt;R/2; r++)
00169       my_infft_plan.<a class="code" href="structinfft__plan.html#o4">y</a>[t*R+(r+R/2)] = <a class="code" href="group__applications__mri3d__construct__data__1d2d.html#ga1">fft</a>[r+R/2]/<a class="code" href="inverse__radon_8c.html#a0">KERNEL</a>(r);
00170   }
00171 
00173   <span class="keywordflow">for</span>(k=0;k&lt;my_nfft_plan.<a class="code" href="structnfft__plan.html#o0">N_total</a>;k++)
00174     my_infft_plan.<a class="code" href="structinfft__plan.html#o5">f_hat_iter</a>[k] = 0.0 + I*0.0;
00175 
00177   <a class="code" href="group__solver.html#ga2">infft_before_loop</a>(&amp;my_infft_plan);
00178 
00179   <span class="keywordflow">if</span> (max_i&lt;1)
00180   {
00181     l=1;
00182     <span class="keywordflow">for</span>(k=0;k&lt;my_nfft_plan.<a class="code" href="structnfft__plan.html#o0">N_total</a>;k++)
00183       my_infft_plan.<a class="code" href="structinfft__plan.html#o5">f_hat_iter</a>[k] = my_infft_plan.<a class="code" href="structinfft__plan.html#o8">p_hat_iter</a>[k];
00184   }
00185   <span class="keywordflow">else</span>
00186   {
00187     <span class="keywordflow">for</span>(l=1;l&lt;=max_i;l++)
00188     {
00189       <a class="code" href="group__solver.html#ga3">infft_loop_one_step</a>(&amp;my_infft_plan);
00190       <span class="comment">/*if (sqrt(my_infft_plan.dot_r_iter)&lt;=1e-12) break;*/</span>
00191     }
00192   }
00193   <span class="comment">/*printf("after %d iteration(s): weighted 2-norm of original residual vector = %g\n",l-1,sqrt(my_infft_plan.dot_r_iter));*/</span>
00194 
00196   <span class="keywordflow">for</span>(k=0;k&lt;my_nfft_plan.<a class="code" href="structnfft__plan.html#o0">N_total</a>;k++)
00197     f[k] = creal(my_infft_plan.<a class="code" href="structinfft__plan.html#o5">f_hat_iter</a>[k]);
00198 
00200   fftw_destroy_plan(my_fftw_plan);
00201   fftw_free(<a class="code" href="group__applications__mri3d__construct__data__1d2d.html#ga1">fft</a>);
00202   <a class="code" href="group__solver.html#ga4">infft_finalize</a>(&amp;my_infft_plan);
00203   <a class="code" href="group__nfft.html#ga15">nfft_finalize</a>(&amp;my_nfft_plan);
00204   free(x);
00205   free(w);
00206   <span class="keywordflow">return</span> 0;
00207 }
00208 
<a name="l00211"></a><a class="code" href="inverse__radon_8c.html#a4">00211</a> <span class="keywordtype">int</span> <a class="code" href="flags_8c.html#a6">main</a>(<span class="keywordtype">int</span> argc,<span class="keywordtype">char</span> **argv)
00212 {
00213   int (*gridfcn)();                     
00214   <span class="keywordtype">int</span> T, R;                             
00215   FILE *fp;
00216   <span class="keywordtype">int</span> N;                                
00217   <span class="keywordtype">double</span> *Rf, *iRf;
00218   <span class="keywordtype">int</span> max_i;                            
00220   <span class="keywordflow">if</span>( argc!=6 )
00221   {
00222     printf(<span class="stringliteral">"inverse_radon gridfcn N T R max_i\n"</span>);
00223     printf(<span class="stringliteral">"\n"</span>);
00224     printf(<span class="stringliteral">"gridfcn    \"polar\" or \"linogram\" \n"</span>);
00225     printf(<span class="stringliteral">"N          image size NxN            \n"</span>);
00226     printf(<span class="stringliteral">"T          number of slopes          \n"</span>);
00227     printf(<span class="stringliteral">"R          number of offsets         \n"</span>);
00228     printf(<span class="stringliteral">"max_i      number of iterations      \n"</span>);
00229     exit(-1);
00230   }
00231 
00232   <span class="keywordflow">if</span> (strcmp(argv[1],<span class="stringliteral">"polar"</span>) == 0)
00233     gridfcn = <a class="code" href="group__applications__polarFFT__polar.html#ga0">polar_grid</a>;
00234   <span class="keywordflow">else</span>
00235     gridfcn = <a class="code" href="group__applications__polarFFT__linogramm.html#ga1">linogram_grid</a>;
00236 
00237   N = atoi(argv[2]);
00238   T = atoi(argv[3]);
00239   R = atoi(argv[4]);
00240   <span class="comment">/*printf("N=%d, %s grid with T=%d, R=%d. \n",N,argv[1],T,R);*/</span>
00241   max_i = atoi(argv[5]);
00242 
00243   Rf  = (<span class="keywordtype">double</span> *)malloc(T*R*(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>)));
00244   iRf = (<span class="keywordtype">double</span> *)malloc(N*N*(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>)));
00245 
00247   fp=fopen(<span class="stringliteral">"sinogram_data.bin"</span>,<span class="stringliteral">"rb"</span>);
00248   <span class="keywordflow">if</span> (fp==NULL)
00249     <span class="keywordflow">return</span>(-1);
00250   fread(Rf,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>),T*R,fp);
00251   fclose(fp);
00252 
00254   <a class="code" href="inverse__radon_8c.html#a3">Inverse_Radon_trafo</a>(gridfcn,T,R,Rf,N,iRf,max_i);
00255 
00257   fp=fopen(<span class="stringliteral">"output_data.bin"</span>,<span class="stringliteral">"wb+"</span>);
00258   <span class="keywordflow">if</span> (fp==NULL)
00259     <span class="keywordflow">return</span>(-1);
00260   fwrite(iRf,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>),N*N,fp);
00261   fclose(fp);
00262 
00264   free(Rf);
00265   free(iRf);
00266 
00267   <span class="keywordflow">return</span> EXIT_SUCCESS;
00268 }
</pre></div>    <hr size="1"/>
    Generated on 22 Jan 2007 by Doxygen 1.4.1
  </body>
</html>
