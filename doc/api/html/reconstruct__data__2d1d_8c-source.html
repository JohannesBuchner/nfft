<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1"/>
    <title>
      NFFT 3.0.3 API Reference - NFFT: reconstruct_data_2d1d.c Source File
    </title>
    <link href="doxygen.css" rel="stylesheet" type="text/css"/>
    <link href="tabs.css" rel="stylesheet" type="text/css"/>
  </head>
  <body>
    <table>
      <tr>
        <td valign="top">
          <img src="images/logo.png" alt="NFFT Logo">
        </td>
        <td align="left" valign="bottom" width="100%">
          <H1nc>3.0.3 API Reference</H1nc>
        </td>
      </tr>
    </table>  
<!-- Generated by Doxygen 1.4.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a></div>
<div class="nav">
<a class="el" href="dir_000006.html">applications</a>&nbsp;/&nbsp;<a class="el" href="dir_000007.html">mri</a>&nbsp;/&nbsp;<a class="el" href="dir_000009.html">mri3d</a></div>
<h1>reconstruct_data_2d1d.c</h1><div class="fragment"><pre class="fragment">00001 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00002 <span class="preprocessor">#include &lt;math.h&gt;</span>
00003 <span class="preprocessor">#include "<a class="code" href="util_8h.html">util.h</a>"</span>
00004 <span class="preprocessor">#include "<a class="code" href="nfft3_8h.html">nfft3.h</a>"</span>
00005 
<a name="l00015"></a><a class="code" href="group__applications__mri3d__reconstruct__data__1d2d.html#ga0">00015</a> <span class="keywordtype">void</span> <a class="code" href="group__applications__mri2d__reconstruct__data__2d.html#ga0">reconstruct</a>(<span class="keywordtype">char</span>* filename,<span class="keywordtype">int</span> N,<span class="keywordtype">int</span> M,<span class="keywordtype">int</span> Z,<span class="keywordtype">int</span> iteration, <span class="keywordtype">int</span> weight, fftw_complex *mem)
00016 {
00017   <span class="keywordtype">int</span> j,k,l,z;                  <span class="comment">/* some variables  */</span>
00018   <span class="keywordtype">double</span> real,imag;             <span class="comment">/* to read the real and imag part of a complex number */</span>
00019   <a class="code" href="structnfft__plan.html">nfft_plan</a> my_plan;            <span class="comment">/* plan for the two dimensional nfft  */</span>
00020   <a class="code" href="structinfft__plan.html">infft_plan</a> my_iplan;          <span class="comment">/* plan for the two dimensional infft */</span>
00021   FILE* fin;                    <span class="comment">/* input file */</span>
00022   <span class="keywordtype">int</span> my_N[2],my_n[2];          <span class="comment">/* to init the nfft */</span>
00023   <span class="keywordtype">double</span> tmp, epsilon=0.0000003;<span class="comment">/* tmp to read the obsolent z from the input file</span>
00024 <span class="comment">                                   epsilon is the break criterium for</span>
00025 <span class="comment">                                   the iteration */</span>
00026   <span class="keywordtype">unsigned</span> infft_flags = <a class="code" href="group__solver.html#ga37">CGNR</a> | <a class="code" href="group__solver.html#ga41">PRECOMPUTE_DAMP</a>; <span class="comment">/* flags for the infft */</span>
00027                                    
00028   <span class="comment">/* initialise my_plan */</span>
00029   my_N[0]=N;my_n[0]=ceil(N*1.2);
00030   my_N[1]=N; my_n[1]=ceil(N*1.2);
00031   <a class="code" href="group__nfft.html#ga9">nfft_init_guru</a>(&amp;my_plan, 2, my_N, M/Z, my_n, 6, <a class="code" href="group__nfft.html#ga16">PRE_PHI_HUT</a>| <a class="code" href="group__nfft.html#ga20">PRE_PSI</a>|
00032                          <a class="code" href="group__nfft.html#ga22">MALLOC_X</a>| <a class="code" href="group__nfft.html#ga23">MALLOC_F_HAT</a>| <a class="code" href="group__nfft.html#ga24">MALLOC_F</a>| 
00033                         <a class="code" href="group__nfft.html#ga26">FFTW_INIT</a>| <a class="code" href="group__nfft.html#ga25">FFT_OUT_OF_PLACE</a>,
00034                         FFTW_MEASURE| FFTW_DESTROY_INPUT);
00035   
00036   <span class="comment">/* precompute lin psi if set */</span>
00037   <span class="keywordflow">if</span>(my_plan.<a class="code" href="structnfft__plan.html#o12">nfft_flags</a> &amp; <a class="code" href="group__nfft.html#ga18">PRE_LIN_PSI</a>)
00038     <a class="code" href="group__nfft.html#ga13">nfft_precompute_lin_psi</a>(&amp;my_plan);
00039   
00040   <span class="comment">/* set the flags for the infft*/</span>
00041   <span class="keywordflow">if</span> (weight)
00042     infft_flags = infft_flags | <a class="code" href="group__solver.html#ga40">PRECOMPUTE_WEIGHT</a>;
00043   
00044   <span class="comment">/* initialise my_iplan, advanced */</span>
00045   <a class="code" href="group__solver.html#ga1">infft_init_advanced</a>(&amp;my_iplan,&amp;my_plan, infft_flags );
00046 
00047   <span class="comment">/* get the weights */</span>
00048   <span class="keywordflow">if</span>(my_iplan.<a class="code" href="structinfft__plan.html#o1">flags</a> &amp; <a class="code" href="group__solver.html#ga40">PRECOMPUTE_WEIGHT</a>)
00049   {
00050     fin=fopen(<span class="stringliteral">"weights.dat"</span>,<span class="stringliteral">"r"</span>);
00051     <span class="keywordflow">for</span>(j=0;j&lt;my_plan.<a class="code" href="structnfft__plan.html#o1">M_total</a>;j++) 
00052     {
00053         fscanf(fin,<span class="stringliteral">"%le "</span>,&amp;my_iplan.<a class="code" href="structinfft__plan.html#o2">w</a>[j]);
00054     }
00055     fclose(fin);
00056   }
00057   
00058   <span class="comment">/* get the damping factors */</span>
00059   <span class="keywordflow">if</span>(my_iplan.<a class="code" href="structinfft__plan.html#o1">flags</a> &amp; <a class="code" href="group__solver.html#ga41">PRECOMPUTE_DAMP</a>)
00060   {
00061     <span class="keywordflow">for</span>(j=0;j&lt;N;j++){
00062       <span class="keywordflow">for</span>(k=0;k&lt;N;k++) {
00063         <span class="keywordtype">int</span> j2= j-N/2;
00064         <span class="keywordtype">int</span> k2= k-N/2;
00065         <span class="keywordtype">double</span> r=sqrt(j2*j2+k2*k2);
00066         <span class="keywordflow">if</span>(r&gt;(double) N/2) 
00067           my_iplan.<a class="code" href="structinfft__plan.html#o3">w_hat</a>[j*N+k]=0.0;
00068         <span class="keywordflow">else</span>
00069           my_iplan.<a class="code" href="structinfft__plan.html#o3">w_hat</a>[j*N+k]=1.0;
00070       }   
00071     }
00072   }
00073   
00074   <span class="comment">/* open the input file */</span>
00075   fin=fopen(filename,<span class="stringliteral">"r"</span>); 
00076 
00077   <span class="comment">/* For every Layer*/</span>
00078   <span class="keywordflow">for</span>(z=0;z&lt;Z;z++) {
00079 
00080     <span class="comment">/* read x,y,freal and fimag from the knots */</span>
00081     <span class="keywordflow">for</span>(j=0;j&lt;my_plan.<a class="code" href="structnfft__plan.html#o1">M_total</a>;j++)
00082     {
00083       fscanf(fin,<span class="stringliteral">"%le %le %le %le %le "</span>,&amp;my_plan.<a class="code" href="structnfft__plan.html#o14">x</a>[2*j+0],&amp;my_plan.<a class="code" href="structnfft__plan.html#o14">x</a>[2*j+1], &amp;tmp,
00084       &amp;real,&amp;imag);
00085       my_iplan.<a class="code" href="structinfft__plan.html#o4">y</a>[j] = real + I*imag;
00086     }
00087     
00088     <span class="comment">/* precompute psi if set just one time because the knots equal each plane */</span>
00089     <span class="keywordflow">if</span>(z==0 &amp;&amp; my_plan.<a class="code" href="structnfft__plan.html#o12">nfft_flags</a> &amp; <a class="code" href="group__nfft.html#ga20">PRE_PSI</a>) 
00090       <a class="code" href="group__nfft.html#ga12">nfft_precompute_psi</a>(&amp;my_plan);
00091       
00092     <span class="comment">/* precompute full psi if set just one time because the knots equal each plane */</span>
00093     <span class="keywordflow">if</span>(z==0 &amp;&amp; my_plan.<a class="code" href="structnfft__plan.html#o12">nfft_flags</a> &amp; <a class="code" href="group__nfft.html#ga21">PRE_FULL_PSI</a>)
00094       <a class="code" href="group__nfft.html#ga11">nfft_precompute_full_psi</a>(&amp;my_plan);
00095 
00096     <span class="comment">/* init some guess */</span>
00097     <span class="keywordflow">for</span>(k=0;k&lt;my_plan.<a class="code" href="structnfft__plan.html#o0">N_total</a>;k++)
00098       my_iplan.<a class="code" href="structinfft__plan.html#o5">f_hat_iter</a>[k]=0.0;
00099  
00100     <span class="comment">/* inverse trafo */</span>
00101     <a class="code" href="group__solver.html#ga2">infft_before_loop</a>(&amp;my_iplan);
00102     <span class="keywordflow">for</span>(l=0;l&lt;iteration;l++)
00103     {
00104       <span class="comment">/* break if dot_r_iter is smaller than epsilon*/</span>
00105       <span class="keywordflow">if</span>(my_iplan.<a class="code" href="structinfft__plan.html#o12">dot_r_iter</a>&lt;epsilon)
00106       <span class="keywordflow">break</span>;
00107       fprintf(stderr,<span class="stringliteral">"%e,  %i of %i\n"</span>,sqrt(my_iplan.<a class="code" href="structinfft__plan.html#o12">dot_r_iter</a>),
00108       iteration*z+l+1,iteration*Z);
00109       <a class="code" href="group__solver.html#ga3">infft_loop_one_step</a>(&amp;my_iplan);
00110     }
00111     <span class="keywordflow">for</span>(k=0;k&lt;my_plan.<a class="code" href="structnfft__plan.html#o0">N_total</a>;k++) {
00112       <span class="comment">/* write every slice in the memory.</span>
00113 <span class="comment">      here we make an fftshift direct */</span>
00114       mem[(Z*N*N/2+z*N*N+ k)%(Z*N*N)] = my_iplan.<a class="code" href="structinfft__plan.html#o5">f_hat_iter</a>[k];
00115     }
00116   }
00117 
00118   fclose(fin);
00119   
00120   <span class="comment">/* finalize the infft */</span>
00121   <a class="code" href="group__solver.html#ga4">infft_finalize</a>(&amp;my_iplan);
00122   
00123   <span class="comment">/* finalize the nfft */</span>
00124   <a class="code" href="group__nfft.html#ga15">nfft_finalize</a>(&amp;my_plan);
00125 }
00126 
<a name="l00131"></a><a class="code" href="group__applications__mri3d__reconstruct__data__1d2d.html#ga1">00131</a> <span class="keywordtype">void</span> <a class="code" href="group__applications__mri3d__reconstruct__data__1d2d.html#ga1">print</a>(<span class="keywordtype">int</span> N,<span class="keywordtype">int</span> M,<span class="keywordtype">int</span> Z, fftw_complex *mem)
00132 {
00133   <span class="keywordtype">int</span> i,j;
00134   FILE* fout_real;
00135   FILE* fout_imag;
00136   fout_real=fopen(<span class="stringliteral">"output_real.dat"</span>,<span class="stringliteral">"w"</span>);
00137   fout_imag=fopen(<span class="stringliteral">"output_imag.dat"</span>,<span class="stringliteral">"w"</span>);
00138 
00139   <span class="keywordflow">for</span>(i=0;i&lt;Z;i++) {
00140     <span class="keywordflow">for</span> (j=0;j&lt;N*N;j++) {
00141       fprintf(fout_real,<span class="stringliteral">"%le "</span>,creal(mem[(Z*N*N/2+i*N*N+ j)%(Z*N*N)]) /Z);
00142       fprintf(fout_imag,<span class="stringliteral">"%le "</span>,cimag(mem[(Z*N*N/2+i*N*N+ j)%(Z*N*N)]) /Z);
00143     }
00144     fprintf(fout_real,<span class="stringliteral">"\n"</span>);
00145     fprintf(fout_imag,<span class="stringliteral">"\n"</span>);
00146   }
00147 
00148   fclose(fout_real);
00149   fclose(fout_imag);
00150 }
00151 
00152 <span class="keywordtype">int</span> <a class="code" href="flags_8c.html#a6">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
00153 {
00154   fftw_complex *mem;
00155   fftw_plan plan;
00156   <span class="keywordtype">int</span> N,M,Z;  
00157 
00158   <span class="keywordflow">if</span> (argc &lt;= 6) {
00159     printf(<span class="stringliteral">"usage: ./reconstruct FILENAME N M Z ITER WEIGHTS\n"</span>);
00160     <span class="keywordflow">return</span> 1;
00161   }
00162 
00163   N=atoi(argv[2]);
00164   M=atoi(argv[3]);
00165   Z=atoi(argv[4]);
00166 
00167   <span class="comment">/* Allocate memory to hold every layer in memory after the</span>
00168 <span class="comment">  2D-infft */</span>
00169   mem = (fftw_complex*) fftw_malloc(<span class="keyword">sizeof</span>(fftw_complex) * atoi(argv[2]) * atoi(argv[2]) * atoi(argv[4]));
00170 
00171   <span class="comment">/* Create plan for the 1d-ifft */</span>
00172   plan = fftw_plan_many_dft(1, &amp;Z, N*N,
00173                                   mem, NULL,
00174                                   N*N, 1,
00175                                   mem, NULL,
00176                                   N*N,1 ,
00177                                   FFTW_BACKWARD, FFTW_MEASURE);
00178   
00179   <span class="comment">/* execute the 2d-infft's */</span>
00180   <a class="code" href="group__applications__mri2d__reconstruct__data__2d.html#ga0">reconstruct</a>(argv[1],N,M,Z,atoi(argv[5]),atoi(argv[6]),mem);
00181 
00182   <span class="comment">/* execute the 1d-fft's */</span>
00183   fftw_execute(plan);
00184 
00185   <span class="comment">/* write the memory back in files */</span>
00186   <a class="code" href="group__applications__mri3d__reconstruct__data__1d2d.html#ga1">print</a>(N,M,Z, mem);
00187 
00188   <span class="comment">/* free memory */</span>
00189   fftw_free(mem);
00190   fftw_destroy_plan(plan);
00191   <span class="keywordflow">return</span> 1;
00192 }
00193 <span class="comment">/* \} */</span>
</pre></div>    <hr size="1"/>
    Generated on 5 Feb 2007 by Doxygen 1.4.1
  </body>
</html>
