<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1"/>
    <title>
      NFFT 3.0.2 API Reference - NFFT: nnfft.c Source File
    </title>
    <link href="doxygen.css" rel="stylesheet" type="text/css"/>
    <link href="tabs.css" rel="stylesheet" type="text/css"/>
  </head>
  <body>
    <table>
      <tr>
        <td valign="top">
          <img src="images/logo.png" alt="NFFT Logo">
        </td>
        <td align="left" valign="bottom" width="100%">
          <H1nc>3.0.2 API Reference</H1nc>
        </td>
      </tr>
    </table>  
<!-- Generated by Doxygen 1.4.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a></div>
<div class="nav">
<a class="el" href="dir_000003.html">kernel</a>&nbsp;/&nbsp;<a class="el" href="dir_000027.html">nnfft</a></div>
<h1>nnfft.c</h1><div class="fragment"><pre class="fragment">00001 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00002 <span class="preprocessor">#include &lt;math.h&gt;</span>
00003 <span class="preprocessor">#include &lt;string.h&gt;</span>
00004 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00005 
00006 <span class="preprocessor">#include "<a class="code" href="util_8h.html">util.h</a>"</span>
00007 <span class="preprocessor">#include "options.h"</span>
00008 <span class="preprocessor">#include "window_defines.h"</span>
00009 
00010 <span class="preprocessor">#include "<a class="code" href="nfft3_8h.html">nfft3.h</a>"</span>
00011 
00012 
00013 <span class="preprocessor">#define MACRO_nndft_init_result_trafo memset(f,0,ths-&gt;M_total*sizeof(complex double));</span>
00014 <span class="preprocessor"></span><span class="preprocessor">#define MACRO_nndft_init_result_conjugated MACRO_nndft_init_result_trafo</span>
00015 <span class="preprocessor"></span><span class="preprocessor">#define MACRO_nndft_init_result_adjoint memset(f_hat,0,ths-&gt;N_total*               \</span>
00016 <span class="preprocessor">                                              sizeof(complex double));</span>
00017 <span class="preprocessor"></span><span class="preprocessor">#define MACRO_nndft_init_result_transposed MACRO_nndft_init_result_adjoint</span>
00018 <span class="preprocessor"></span>
00019 <span class="preprocessor">#define MACRO_nndft_sign_trafo      (+2.0*PI)</span>
00020 <span class="preprocessor"></span><span class="preprocessor">#define MACRO_nndft_sign_conjugated (-2.0*PI)</span>
00021 <span class="preprocessor"></span><span class="preprocessor">#define MACRO_nndft_sign_adjoint    (-2.0*PI)</span>
00022 <span class="preprocessor"></span><span class="preprocessor">#define MACRO_nndft_sign_transposed (+2.0*PI)</span>
00023 <span class="preprocessor"></span>
00024 <span class="preprocessor">#define MACRO_nndft_compute_trafo (*fj) += (*f_hat_k)*cexp(-I*omega);</span>
00025 <span class="preprocessor"></span>
00026 <span class="preprocessor">#define MACRO_nndft_compute_conjugated MACRO_nndft_compute_trafo</span>
00027 <span class="preprocessor"></span>
00028 <span class="preprocessor">#define MACRO_nndft_compute_adjoint (*f_hat_k) += (*fj)*cexp(+I*omega);</span>
00029 <span class="preprocessor"></span>
00030 <span class="preprocessor">#define MACRO_nndft_compute_transposed MACRO_nndft_compute_adjoint</span>
00031 <span class="preprocessor"></span>
00032 <span class="preprocessor">#define MACRO_nndft(which_one)                                                 \</span>
00033 <span class="preprocessor">void nndft_ ## which_one (nnfft_plan *ths)                                    \</span>
00034 <span class="preprocessor">{                                                                              \</span>
00035 <span class="preprocessor">  int j;                                \</span>
00036 <span class="preprocessor">  int t;                                \</span>
00037 <span class="preprocessor">  int l;                                \</span>
00038 <span class="preprocessor">  complex double *f_hat, *f;                   \</span>
00039 <span class="preprocessor">  complex double *f_hat_k;                     \</span>
00040 <span class="preprocessor">  complex double *fj;                          \</span>
00041 <span class="preprocessor">  double omega;                         \</span>
00042 <span class="preprocessor">                                                                               \</span>
00043 <span class="preprocessor">  f_hat=ths-&gt;f_hat; f=ths-&gt;f;                                                \</span>
00044 <span class="preprocessor">                                                                               \</span>
00045 <span class="preprocessor">  MACRO_nndft_init_result_ ## which_one                                        \</span>
00046 <span class="preprocessor">                                                                               \</span>
00047 <span class="preprocessor">  for(j=0, fj=f; j&lt;ths-&gt;M_total; j++, fj++)                                     \</span>
00048 <span class="preprocessor">  {                                                                            \</span>
00049 <span class="preprocessor">    for(l=0, f_hat_k=f_hat; l&lt;ths-&gt;N_total; l++, f_hat_k++)                    \</span>
00050 <span class="preprocessor">    {                                                                          \</span>
00051 <span class="preprocessor">      omega=0.0;                                                               \</span>
00052 <span class="preprocessor">      for(t = 0; t&lt;ths-&gt;d; t++)                                               \</span>
00053 <span class="preprocessor">        omega+=ths-&gt;v[l*ths-&gt;d+t] * ths-&gt;x[j*ths-&gt;d+t] * ths-&gt;N[t];           \</span>
00054 <span class="preprocessor">                                                                               \</span>
00055 <span class="preprocessor">      omega*= MACRO_nndft_sign_ ## which_one;                                  \</span>
00056 <span class="preprocessor">                                                                               \</span>
00057 <span class="preprocessor">      MACRO_nndft_compute_ ## which_one                                        \</span>
00058 <span class="preprocessor">                                                                               \</span>
00059 <span class="preprocessor">     } </span><span class="comment">/* for(l) */</span>                                                            \
00060    } <span class="comment">/* for(j) */</span>                                                              \
00061 } <span class="comment">/* nndft_trafo */</span>                                                            \
00062 
00063 MACRO_nndft(trafo)
<a name="l00064"></a><a class="code" href="group__nnfft.html#ga2">00064</a> MACRO_nndft(adjoint)
<a name="l00065"></a><a class="code" href="group__nnfft.html#ga3">00065</a> 
00068 <span class="keywordtype">void</span> nnfft_uo(<a class="code" href="structnnfft__plan.html">nnfft_plan</a> *ths,<span class="keywordtype">int</span> j,<span class="keywordtype">int</span> *up,<span class="keywordtype">int</span> *op,<span class="keywordtype">int</span> act_dim)
00069 {
00070   <span class="keywordtype">double</span> c;
00071   <span class="keywordtype">int</span> u,o;
00072 
00073   c = ths-&gt;v[j*ths-&gt;d+act_dim] * ths-&gt;n[act_dim];
00074   
00075   u = c; o = c;
00076   <span class="keywordflow">if</span>(c &lt; 0)                  
00077     u = u-1;                  
00078   <span class="keywordflow">else</span>
00079     o = o+1;
00080   
00081   u = u - (ths-&gt;m); o = o + (ths-&gt;m);
00082 
00083   up[0]=u; op[0]=o;
00084 }
00085 
00089 <span class="preprocessor">#define MACRO_nnfft_B_init_result_A memset(f,0,ths-&gt;M_total*sizeof(complex double));</span>
00090 <span class="preprocessor"></span><span class="preprocessor">#define MACRO_nnfft_B_init_result_T memset(g,0,ths-&gt;aN1_total*sizeof(complex double));</span>
00091 <span class="preprocessor"></span>
00092 <span class="preprocessor">#define MACRO_nnfft_B_PRE_FULL_PSI_compute_A {                                  \</span>
00093 <span class="preprocessor">  (*fj) += ths-&gt;psi[ix] * g[ths-&gt;psi_index_g[ix]];                           \</span>
00094 <span class="preprocessor">}</span>
00095 <span class="preprocessor"></span>
00096 <span class="preprocessor">#define MACRO_nnfft_B_PRE_FULL_PSI_compute_T {                                  \</span>
00097 <span class="preprocessor">  g[ths-&gt;psi_index_g[ix]] += ths-&gt;psi[ix] * (*fj);                           \</span>
00098 <span class="preprocessor">}</span>
00099 <span class="preprocessor"></span>
00100 <span class="preprocessor">#define MACRO_nnfft_B_compute_A {                                               \</span>
00101 <span class="preprocessor">  (*fj) += phi_prod[ths-&gt;d] * g[ll_plain[ths-&gt;d]];                        \</span>
00102 <span class="preprocessor">}</span>
00103 <span class="preprocessor"></span>
00104 <span class="preprocessor">#define MACRO_nnfft_B_compute_T {                                               \</span>
00105 <span class="preprocessor">  g[ll_plain[ths-&gt;d]] += phi_prod[ths-&gt;d] * (*fj);                        \</span>
00106 <span class="preprocessor">}</span>
00107 <span class="preprocessor"></span>
00108   <span class="comment">/* Gewicht, d.h., Nachkommaanteil y-y_u im Speicher halten!!! */</span>
00109 <span class="preprocessor">#define MACRO_with_PRE_LIN_PSI (ths-&gt;psi[(ths-&gt;K+1)*t2+y_u[t2]]*             \</span>
00110 <span class="preprocessor">                                (y_u[t2]+1-y[t2]) +                            \</span>
00111 <span class="preprocessor">                                ths-&gt;psi[(ths-&gt;K+1)*t2+y_u[t2]+1]*           \</span>
00112 <span class="preprocessor">                                (y[t2]-y_u[t2])) </span>
00113 <span class="preprocessor"></span><span class="preprocessor">#define MACRO_with_PRE_PSI     ths-&gt;psi[(j*ths-&gt;d+t2)*(2*ths-&gt;m+2)+lj[t2]]</span>
00114 <span class="preprocessor"></span><span class="preprocessor">#define MACRO_without_PRE_PSI  PHI(-ths-&gt;v[j*ths-&gt;d+t2]+                      \</span>
00115 <span class="preprocessor">                               ((double)l[t2])/ths-&gt;N1[t2], t2)</span>
00116 <span class="preprocessor"></span>
00117 <span class="preprocessor">#define MACRO_init_uo_l_lj_t {                                                 \</span>
00118 <span class="preprocessor">  for(t = ths-&gt;d-1; t&gt;=0; t--)                                                \</span>
00119 <span class="preprocessor">    {                                                                          \</span>
00120 <span class="preprocessor">      nnfft_uo(ths,j,&amp;u[t],&amp;o[t],t);                                           \</span>
00121 <span class="preprocessor">      l[t] = u[t];                                                             \</span>
00122 <span class="preprocessor">      lj[t] = 0;                                                               \</span>
00123 <span class="preprocessor">    } </span><span class="comment">/* for(t) */</span>                                                             \
00124   t++;                                                                         \
00125 }
00126 
00127 <span class="preprocessor">#define MACRO_update_with_PRE_PSI_LIN {                                        \</span>
00128 <span class="preprocessor">  for(t2=t; t2&lt;ths-&gt;d; t2++)                                                  \</span>
00129 <span class="preprocessor">    {                                                                          \</span>
00130 <span class="preprocessor">      y[t2] = fabs(((-ths-&gt;N1[t2]*ths-&gt;v[j*ths-&gt;d+t2]+(double)l[t2])          \</span>
00131 <span class="preprocessor">          * ((double)ths-&gt;K))/(ths-&gt;m+1));                                   \</span>
00132 <span class="preprocessor">      y_u[t2] = (int)y[t2];                                                    \</span>
00133 <span class="preprocessor">    } </span><span class="comment">/* for(t2) */</span>                                                            \
00134 }
00135 
00136 <span class="preprocessor">#define MACRO_update_phi_prod_ll_plain(which_one) {                            \</span>
00137 <span class="preprocessor">  for(t2=t; t2&lt;ths-&gt;d; t2++)                                                  \</span>
00138 <span class="preprocessor">    {                                                                          \</span>
00139 <span class="preprocessor">      phi_prod[t2+1]=phi_prod[t2]* MACRO_ ## which_one;                        \</span>
00140 <span class="preprocessor">      ll_plain[t2+1]=ll_plain[t2]*ths-&gt;aN1[t2] +(l[t2]+ths-&gt;aN1[t2]*3/2)%ths-&gt;aN1[t2]; </span><span class="comment">/* 3/2 because of the (not needed) fftshift and to be in [0 aN1[t2]] ?! */</span>   \
00141     } <span class="comment">/* for(t2) */</span>                                                            \
00142 }
00143 
00144 <span class="preprocessor">#define MACRO_count_uo_l_lj_t {                                                \</span>
00145 <span class="preprocessor">  for(t = ths-&gt;d-1; (t&gt;0)&amp;&amp;(l[t]==o[t]); t--)                                 \</span>
00146 <span class="preprocessor">    {                                                                          \</span>
00147 <span class="preprocessor">      l[t] = u[t];                                                             \</span>
00148 <span class="preprocessor">      lj[t] = 0;                                                               \</span>
00149 <span class="preprocessor">    } </span><span class="comment">/* for(t) */</span>                                                             \
00150                                                                                \
00151   l[t]++;                                                                      \
00152   lj[t]++;                                                                     \
00153 }
00154 
00155 <span class="preprocessor">#define MACRO_nnfft_B(which_one)                                                \</span>
00156 <span class="preprocessor">inline void nnfft_B_ ## which_one (nnfft_plan *ths)                           \</span>
00157 <span class="preprocessor">{                                                                              \</span>
00158 <span class="preprocessor">  int lprod;                            \</span>
00159 <span class="preprocessor">  int u[ths-&gt;d], o[ths-&gt;d];           \</span>
00160 <span class="preprocessor">  int t, t2;                            \</span>
00161 <span class="preprocessor">  int j;                                \</span>
00162 <span class="preprocessor">  int l_L, ix;                          \</span>
00163 <span class="preprocessor">  int l[ths-&gt;d];                       \</span>
00164 <span class="preprocessor">  int lj[ths-&gt;d];                      \</span>
00165 <span class="preprocessor">  int ll_plain[ths-&gt;d+1];              \</span>
00166 <span class="preprocessor">  double phi_prod[ths-&gt;d+1];           \</span>
00167 <span class="preprocessor">  complex double *f, *g;                  \</span>
00168 <span class="preprocessor">  complex double *fj;                     \</span>
00169 <span class="preprocessor">  double y[ths-&gt;d];                                                           \</span>
00170 <span class="preprocessor">  int y_u[ths-&gt;d];                                                            \</span>
00171 <span class="preprocessor">                                                                               \</span>
00172 <span class="preprocessor">  f=ths-&gt;f_hat; g=ths-&gt;F;                                                    \</span>
00173 <span class="preprocessor">                                                                               \</span>
00174 <span class="preprocessor">  MACRO_nnfft_B_init_result_ ## which_one                                                 \</span>
00175 <span class="preprocessor">                                                                               \</span>
00176 <span class="preprocessor">  if(ths-&gt;nnfft_flags &amp; PRE_FULL_PSI)        \</span>
00177 <span class="preprocessor">    {                                                                          \</span>
00178 <span class="preprocessor">      for(ix=0, j=0, fj=f; j&lt;ths-&gt;N_total; j++,fj++)\</span>
00179 <span class="preprocessor">        for(l_L=0; l_L&lt;ths-&gt;psi_index_f[j]; l_L++, ix++)                      \</span>
00180 <span class="preprocessor">          MACRO_nnfft_B_PRE_FULL_PSI_compute_ ## which_one;                                \</span>
00181 <span class="preprocessor">      return;                                                                  \</span>
00182 <span class="preprocessor">    }                                                                          \</span>
00183 <span class="preprocessor">                                                                               \</span>
00184 <span class="preprocessor">  phi_prod[0]=1;                                                               \</span>
00185 <span class="preprocessor">  ll_plain[0]=0;                                                               \</span>
00186 <span class="preprocessor">                                                                               \</span>
00187 <span class="preprocessor">  for(t=0,lprod = 1; t&lt;ths-&gt;d; t++)                                           \</span>
00188 <span class="preprocessor">    lprod *= (2*ths-&gt;m+2);                                                    \</span>
00189 <span class="preprocessor">                                                                               \</span>
00190 <span class="preprocessor">  if(ths-&gt;nnfft_flags &amp; PRE_PSI)                                               \</span>
00191 <span class="preprocessor">    {                                                                          \</span>
00192 <span class="preprocessor">      for(j=0, fj=f; j&lt;ths-&gt;N_total; j++, fj++)     \</span>
00193 <span class="preprocessor">        {                                                                      \</span>
00194 <span class="preprocessor">          MACRO_init_uo_l_lj_t;                                                \</span>
00195 <span class="preprocessor">                                                                               \</span>
00196 <span class="preprocessor">          for(l_L=0; l_L&lt;lprod; l_L++)                                         \</span>
00197 <span class="preprocessor">            {                                                                  \</span>
00198 <span class="preprocessor">              MACRO_update_phi_prod_ll_plain(with_PRE_PSI);                    \</span>
00199 <span class="preprocessor">                                                                               \</span>
00200 <span class="preprocessor">              MACRO_nnfft_B_compute_ ## which_one;                              \</span>
00201 <span class="preprocessor">                                                                               \</span>
00202 <span class="preprocessor">              MACRO_count_uo_l_lj_t;                                           \</span>
00203 <span class="preprocessor">            } </span><span class="comment">/* for(l_L) */</span>                                                   \
00204         } <span class="comment">/* for(j) */</span>                                                         \
00205       return;                                                                  \
00206     } <span class="comment">/* if(PRE_PSI) */</span>                                                        \
00207                                                                                \
00208   if(ths-&gt;nnfft_flags &amp; PRE_LIN_PSI)                                           \
00209     {                                                                          \
00210       for(j=0, fj=f; j&lt;ths-&gt;N_total; j++, fj++)     \
00211         {                                                            \
00212           MACRO_init_uo_l_lj_t;                                                \
00213                                                                                \
00214           for(l_L=0; l_L&lt;lprod; l_L++)                                         \
00215             {                                                                  \
00216               MACRO_update_with_PRE_PSI_LIN;                                   \
00217                                                                                \
00218               MACRO_update_phi_prod_ll_plain(with_PRE_LIN_PSI);                \
00219                                                                                \
00220               MACRO_nnfft_B_compute_ ## which_one;                              \
00221                                                                                \
00222               MACRO_count_uo_l_lj_t;                                           \
00223             } <span class="comment">/* for(l_L) */</span>                                                   \
00224         } <span class="comment">/* for(j) */</span>                                                         \
00225       return;                                                                  \
00226     } <span class="comment">/* if(PRE_LIN_PSI) */</span>                                                    \
00227                                                                                \
00228   <span class="comment">/* no precomputed psi at all */</span>                                              \
00229   for(j=0, fj=f; j&lt;ths-&gt;N_total; j++, fj++)         \
00230     {                  \
00231                                                 \
00232       MACRO_init_uo_l_lj_t;                                                    \
00233                                                                                \
00234       for(l_L=0; l_L&lt;lprod; l_L++)                                             \
00235         {                                                                      \
00236           MACRO_update_phi_prod_ll_plain(without_PRE_PSI);                     \
00237                                                                               \
00238           MACRO_nnfft_B_compute_ ## which_one;                                  \
00239                                                                                \
00240           MACRO_count_uo_l_lj_t;                                               \
00241         } <span class="comment">/* for(l_L) */</span>                                                     \
00242     } <span class="comment">/* for(j) */</span>                                                            \
00243 } <span class="comment">/* nnfft_B */</span>               
00244 
00245 MACRO_nnfft_B(A)
00246 MACRO_nnfft_B(T)
00247 
00248 inline <span class="keywordtype">void</span> nnfft_D (<a class="code" href="structnnfft__plan.html">nnfft_plan</a> *ths){
00249   <span class="keywordtype">int</span> j,t;
00250   <span class="keywordtype">double</span> tmp;
00251   
00252   <span class="keywordflow">if</span>(ths-&gt;nnfft_flags &amp; <a class="code" href="group__nfft.html#ga16">PRE_PHI_HUT</a>) {
00253     <span class="keywordflow">for</span>(j=0; j&lt;ths-&gt;M_total; j++)
00254       ths-&gt;f[j] *= ths-&gt;c_phi_inv[j];
00255   } <span class="keywordflow">else</span> {
00256     <span class="keywordflow">for</span>(j=0; j&lt;ths-&gt;M_total; j++)
00257     {
00258       tmp = 1.0;
00259       <span class="comment">/* multiply with N1, because x was modified */</span>
00260       <span class="keywordflow">for</span>(t=0; t&lt;ths-&gt;d; t++)
00261         tmp*= 1.0 /((PHI_HUT(ths-&gt;x[ths-&gt;d*j + t]*((<span class="keywordtype">double</span>)ths-&gt;N[t]),t)) );
00262       ths-&gt;f[j] *= tmp;
00263     }
00264   }
00265 }
00266 
00269 <span class="keywordtype">void</span> <a class="code" href="group__nnfft.html#ga4">nnfft_trafo</a>(<a class="code" href="structnnfft__plan.html">nnfft_plan</a> *ths)
<a name="l00270"></a><a class="code" href="group__nnfft.html#ga4">00270</a> {
00271   <span class="keywordtype">int</span> j,t;
00272 
00273   nnfft_B_T(ths);
00274 
00275   <span class="keywordflow">for</span>(j=0;j&lt;ths-&gt;M_total;j++) {  
00276     <span class="keywordflow">for</span>(t=0;t&lt;ths-&gt;d;t++) {
00277       ths-&gt;x[j*ths-&gt;d+t]= ths-&gt;x[j*ths-&gt;d+t] / ((double)ths-&gt;sigma[t]);
00278     }
00279   }
00280   
00281   ths-&gt;direct_plan-&gt;f = ths-&gt;f;
00282   <a class="code" href="group__nfft.html#ga2">nfft_trafo</a>(ths-&gt;direct_plan);
00283   
00284   <span class="keywordflow">for</span>(j=0;j&lt;ths-&gt;M_total;j++) {  
00285     <span class="keywordflow">for</span>(t=0;t&lt;ths-&gt;d;t++) {
00286       ths-&gt;x[j*ths-&gt;d+t]= ths-&gt;x[j*ths-&gt;d+t] * ((double)ths-&gt;sigma[t]);
00287     }
00288   }
00289   
00290   nnfft_D(ths);
00291 } <span class="comment">/* nnfft_trafo */</span>
00292 
00293 <span class="keywordtype">void</span> <a class="code" href="group__nnfft.html#ga5">nnfft_adjoint</a>(<a class="code" href="structnnfft__plan.html">nnfft_plan</a> *ths)
<a name="l00294"></a><a class="code" href="group__nnfft.html#ga5">00294</a> {
00295   <span class="keywordtype">int</span> j,t;
00296   
00297   nnfft_D(ths);
00298   
00299   <span class="keywordflow">for</span>(j=0;j&lt;ths-&gt;M_total;j++) {  
00300     <span class="keywordflow">for</span>(t=0;t&lt;ths-&gt;d;t++) {
00301       ths-&gt;x[j*ths-&gt;d+t]= ths-&gt;x[j*ths-&gt;d+t] / ((double)ths-&gt;sigma[t]);
00302     }
00303   }
00304   
00305   ths-&gt;direct_plan-&gt;f = ths-&gt;f;
00306   <a class="code" href="group__nfft.html#ga3">nfft_adjoint</a>(ths-&gt;direct_plan);
00307   
00308   <span class="keywordflow">for</span>(j=0;j&lt;ths-&gt;M_total;j++) {  
00309     <span class="keywordflow">for</span>(t=0;t&lt;ths-&gt;d;t++) {
00310       ths-&gt;x[j*ths-&gt;d+t]= ths-&gt;x[j*ths-&gt;d+t] * ((double)ths-&gt;sigma[t]);
00311     }
00312   }  
00313   
00314   nnfft_B_A(ths);
00315 } <span class="comment">/* nnfft_adjoint */</span>
00316 
00319 <span class="keywordtype">void</span> <a class="code" href="group__nnfft.html#ga9">nnfft_precompute_phi_hut</a>(<a class="code" href="structnnfft__plan.html">nnfft_plan</a> *ths)
<a name="l00320"></a><a class="code" href="group__nnfft.html#ga9">00320</a> {
00321   <span class="keywordtype">int</span> j;                                
00322   <span class="keywordtype">int</span> t;                                
00323   <span class="keywordtype">double</span> tmp;
00324 
00325   ths-&gt;c_phi_inv= (<span class="keywordtype">double</span>*)fftw_malloc(ths-&gt;M_total*<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
00326   
00327   <span class="keywordflow">for</span>(j=0; j&lt;ths-&gt;M_total; j++)
00328     {
00329       tmp = 1.0;
00330       <span class="keywordflow">for</span>(t=0; t&lt;ths-&gt;d; t++)
00331         tmp*= 1.0 /(PHI_HUT(ths-&gt;x[ths-&gt;d*j + t]*((<span class="keywordtype">double</span>)ths-&gt;N[t]),t));
00332       ths-&gt;c_phi_inv[j]=tmp;
00333     }
00334 } <span class="comment">/* nnfft_phi_hut */</span>
00335 
00336 
00341 <span class="keywordtype">void</span> <a class="code" href="group__nnfft.html#ga6">nnfft_precompute_lin_psi</a>(<a class="code" href="structnnfft__plan.html">nnfft_plan</a> *ths)
<a name="l00342"></a><a class="code" href="group__nnfft.html#ga6">00342</a> {
00343   <span class="keywordtype">int</span> t;                                
00344   <span class="keywordtype">int</span> j;                                
00345   <span class="keywordtype">double</span> step;                          
00347   <a class="code" href="group__nfft.html#ga13">nfft_precompute_lin_psi</a>(ths-&gt;direct_plan);
00348   
00349   <span class="keywordflow">for</span> (t=0; t&lt;ths-&gt;d; t++)
00350     {
00351       step=((double)(ths-&gt;m+1))/(ths-&gt;K*ths-&gt;N1[t]);
00352       <span class="keywordflow">for</span>(j=0;j&lt;=ths-&gt;K;j++)
00353         {
00354           ths-&gt;psi[(ths-&gt;K+1)*t + j] = PHI(j*step,t);
00355         } <span class="comment">/* for(j) */</span>
00356     } <span class="comment">/* for(t) */</span>
00357 }
00358 
00359 <span class="keywordtype">void</span> <a class="code" href="group__nnfft.html#ga7">nnfft_precompute_psi</a>(<a class="code" href="structnnfft__plan.html">nnfft_plan</a> *ths)
<a name="l00360"></a><a class="code" href="group__nnfft.html#ga7">00360</a> {
00361   <span class="keywordtype">int</span> t;                                
00362   <span class="keywordtype">int</span> j;                                
00363   <span class="keywordtype">int</span> l;                                
00364   <span class="keywordtype">int</span> lj;                               
00365   <span class="keywordtype">int</span> u, o;                             
00367   <span class="keywordflow">for</span> (t=0; t&lt;ths-&gt;d; t++)
00368     <span class="keywordflow">for</span>(j=0;j&lt;ths-&gt;N_total;j++)
00369       {
00370         nnfft_uo(ths,j,&amp;u,&amp;o,t);
00371         
00372         <span class="keywordflow">for</span>(l=u, lj=0; l &lt;= o; l++, lj++)
00373           ths-&gt;psi[(j*ths-&gt;d+t)*(2*ths-&gt;m+2)+lj]=
00374             (PHI((-ths-&gt;v[j*ths-&gt;d+t]+((<span class="keywordtype">double</span>)l)/((<span class="keywordtype">double</span>)ths-&gt;N1[t])),t));
00375       } <span class="comment">/* for(j) */</span>
00376       
00377   <span class="keywordflow">for</span>(j=0;j&lt;ths-&gt;M_total;j++) {  
00378     <span class="keywordflow">for</span>(t=0;t&lt;ths-&gt;d;t++) {
00379       ths-&gt;x[j*ths-&gt;d+t]= ths-&gt;x[j*ths-&gt;d+t] / ((double)ths-&gt;sigma[t]);
00380     }
00381   }
00382   
00383   <a class="code" href="group__nfft.html#ga12">nfft_precompute_psi</a>(ths-&gt;direct_plan);
00384   
00385   <span class="keywordflow">for</span>(j=0;j&lt;ths-&gt;M_total;j++) {  
00386     <span class="keywordflow">for</span>(t=0;t&lt;ths-&gt;d;t++) {
00387       ths-&gt;x[j*ths-&gt;d+t]= ths-&gt;x[j*ths-&gt;d+t] * ((double)ths-&gt;sigma[t]);
00388     }
00389   }
00390   <span class="comment">/* for(t) */</span>
00391 } <span class="comment">/* nfft_precompute_psi */</span>
00392 
00393 
00394 
00398 <span class="keywordtype">void</span> <a class="code" href="group__nnfft.html#ga8">nnfft_precompute_full_psi</a>(<a class="code" href="structnnfft__plan.html">nnfft_plan</a> *ths)
<a name="l00399"></a><a class="code" href="group__nnfft.html#ga8">00399</a> {
00400   <span class="keywordtype">int</span> t,t2;                             
00401   <span class="keywordtype">int</span> j;                                
00402   <span class="keywordtype">int</span> l_L;                              
00403   <span class="keywordtype">int</span> l[ths-&gt;d];                       
00404   <span class="keywordtype">int</span> lj[ths-&gt;d];                      
00405   <span class="keywordtype">int</span> ll_plain[ths-&gt;d+1];              
00406   <span class="keywordtype">int</span> lprod;                            
00407   <span class="keywordtype">int</span> u[ths-&gt;d], o[ths-&gt;d];           
00409   <span class="keywordtype">double</span> phi_prod[ths-&gt;d+1];
00410 
00411   <span class="keywordtype">int</span> ix,ix_old;
00412   
00413   <span class="keywordflow">for</span>(j=0;j&lt;ths-&gt;M_total;j++) {  
00414     <span class="keywordflow">for</span>(t=0;t&lt;ths-&gt;d;t++) {
00415       ths-&gt;x[j*ths-&gt;d+t]= ths-&gt;x[j*ths-&gt;d+t] / ((double)ths-&gt;sigma[t]);
00416     }
00417   }
00418   
00419   <a class="code" href="group__nnfft.html#ga7">nnfft_precompute_psi</a>(ths);
00420   
00421   <a class="code" href="group__nfft.html#ga11">nfft_precompute_full_psi</a>(ths-&gt;direct_plan);
00422   
00423   <span class="keywordflow">for</span>(j=0;j&lt;ths-&gt;M_total;j++) {  
00424     <span class="keywordflow">for</span>(t=0;t&lt;ths-&gt;d;t++) {
00425       ths-&gt;x[j*ths-&gt;d+t]= ths-&gt;x[j*ths-&gt;d+t] * ((double)ths-&gt;sigma[t]);
00426     }
00427   }
00428   
00429   phi_prod[0]=1;
00430   ll_plain[0]=0;
00431 
00432   <span class="keywordflow">for</span>(t=0,lprod = 1; t&lt;ths-&gt;d; t++)
00433     lprod *= 2*ths-&gt;m+2;
00434   
00435   <span class="keywordflow">for</span>(j=0,ix=0,ix_old=0; j&lt;ths-&gt;N_total; j++)
00436     {
00437       MACRO_init_uo_l_lj_t;
00438       
00439       <span class="keywordflow">for</span>(l_L=0; l_L&lt;lprod; l_L++, ix++)
00440         {
00441           MACRO_update_phi_prod_ll_plain(without_PRE_PSI);
00442           
00443           ths-&gt;psi_index_g[ix]=ll_plain[ths-&gt;d];
00444           ths-&gt;psi[ix]=phi_prod[ths-&gt;d];
00445            
00446           MACRO_count_uo_l_lj_t;
00447         } <span class="comment">/* for(l_L) */</span>
00448       
00449       
00450       ths-&gt;psi_index_f[j]=ix-ix_old;
00451       ix_old=ix;
00452     } <span class="comment">/* for(j) */</span>
00453 }
00454 
00455 <span class="keywordtype">void</span> nnfft_init_help(<a class="code" href="structnnfft__plan.html">nnfft_plan</a> *ths, <span class="keywordtype">int</span> m2, <span class="keywordtype">unsigned</span> nfft_flags, <span class="keywordtype">unsigned</span> fftw_flags)
00456 {
00457   <span class="keywordtype">int</span> t;                                
00458   <span class="keywordtype">int</span> lprod;                            
00459   <span class="keywordtype">int</span> N2[ths-&gt;d];
00460 
00461   ths-&gt;aN1 = (<span class="keywordtype">int</span>*) fftw_malloc(ths-&gt;d*<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00462   
00463   ths-&gt;a = (<span class="keywordtype">double</span>*) fftw_malloc(ths-&gt;d*<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
00464   
00465   ths-&gt;sigma = (<span class="keywordtype">double</span>*) fftw_malloc(ths-&gt;d*<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
00466   
00467   ths-&gt;n = ths-&gt;N1;
00468   
00469   ths-&gt;aN1_total=1;
00470   
00471   <span class="keywordflow">for</span>(t = 0; t&lt;ths-&gt;d; t++) {
00472     ths-&gt;a[t] = 1.0 + (2.0*((double)ths-&gt;m))/((double)ths-&gt;N1[t]);
00473     ths-&gt;aN1[t] = ths-&gt;a[t] * ((double)ths-&gt;N1[t]);
00474     <span class="comment">/* aN1 should be even */</span>
00475     <span class="keywordflow">if</span>(ths-&gt;aN1[t]%2 != 0)
00476       ths-&gt;aN1[t] = ths-&gt;aN1[t] +1;
00477       
00478     ths-&gt;aN1_total*=ths-&gt;aN1[t];
00479     ths-&gt;sigma[t] = ((double) ths-&gt;N1[t] )/((double) ths-&gt;N[t]);;
00480     
00481     <span class="comment">/* take the same oversampling factor in the inner NFFT */</span>
00482     N2[t] = ceil(ths-&gt;sigma[t]*(ths-&gt;aN1[t]));
00483     
00484     <span class="comment">/* N2 should be even */</span>
00485     <span class="keywordflow">if</span>(N2[t]%2 != 0)
00486       N2[t] = N2[t] +1;
00487   }
00488   
00489   WINDOW_HELP_INIT
00490   
00491   <span class="keywordflow">if</span>(ths-&gt;nnfft_flags &amp; <a class="code" href="group__nfft.html#ga22">MALLOC_X</a>)
00492     ths-&gt;x = (<span class="keywordtype">double</span>*)fftw_malloc(ths-&gt;d*ths-&gt;M_total*
00493                                         <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
00494                                         
00495   <span class="keywordflow">if</span>(ths-&gt;nnfft_flags &amp; <a class="code" href="group__nnfft.html#ga11">MALLOC_V</a>)
00496     ths-&gt;v = (<span class="keywordtype">double</span>*)fftw_malloc(ths-&gt;d*ths-&gt;N_total*
00497                                         <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
00498 
00499   <span class="keywordflow">if</span>(ths-&gt;nnfft_flags &amp; <a class="code" href="group__nfft.html#ga23">MALLOC_F_HAT</a>)
00500     ths-&gt;f_hat = (complex <span class="keywordtype">double</span>*)fftw_malloc(ths-&gt;N_total*
00501                                                   <span class="keyword">sizeof</span>(complex <span class="keywordtype">double</span>));
00502   <span class="keywordflow">if</span>(ths-&gt;nnfft_flags &amp; <a class="code" href="group__nfft.html#ga24">MALLOC_F</a>)
00503     ths-&gt;f=(complex <span class="keywordtype">double</span>*)fftw_malloc(ths-&gt;M_total*<span class="keyword">sizeof</span>(complex <span class="keywordtype">double</span>));
00504     
00505   <span class="keywordflow">if</span>(ths-&gt;nnfft_flags &amp; <a class="code" href="group__nfft.html#ga18">PRE_LIN_PSI</a>)
00506   {
00507     ths-&gt;K=100000; <span class="comment">/* estimate is badly needed !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/</span>
00508     ths-&gt;psi = (<span class="keywordtype">double</span>*) fftw_malloc((ths-&gt;K+1)*ths-&gt;d*<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
00509   }
00510     
00511   <span class="comment">/* NO FFTW_MALLOC HERE */</span>
00512   <span class="keywordflow">if</span>(ths-&gt;nnfft_flags &amp; <a class="code" href="group__nfft.html#ga20">PRE_PSI</a>)
00513     ths-&gt;psi = (<span class="keywordtype">double</span>*) malloc(ths-&gt;N_total*ths-&gt;d*
00514                                            (2*ths-&gt;m+2)*<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
00515 
00516   <span class="keywordflow">if</span>(ths-&gt;nnfft_flags &amp; <a class="code" href="group__nfft.html#ga21">PRE_FULL_PSI</a>)
00517   {
00518       <span class="keywordflow">for</span>(t=0,lprod = 1; t&lt;ths-&gt;d; t++)
00519           lprod *= 2*ths-&gt;m+2;
00520       
00521       ths-&gt;psi = (<span class="keywordtype">double</span>*) fftw_malloc(ths-&gt;M_total*lprod*<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
00522 
00523       ths-&gt;psi_index_f = (<span class="keywordtype">int</span>*) fftw_malloc(ths-&gt;M_total*<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00524       ths-&gt;psi_index_g = (<span class="keywordtype">int</span>*) fftw_malloc(ths-&gt;M_total*lprod*<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00525   }
00526                                            
00527   ths-&gt;direct_plan = (<a class="code" href="structnfft__plan.html">nfft_plan</a>*) malloc(<span class="keyword">sizeof</span>(<a class="code" href="structnfft__plan.html">nfft_plan</a>));
00528     
00529   <a class="code" href="group__nfft.html#ga9">nfft_init_guru</a>(ths-&gt;direct_plan, ths-&gt;d, ths-&gt;aN1, ths-&gt;M_total, N2, m2, 
00530                  nfft_flags, fftw_flags);
00531                         
00532   ths-&gt;direct_plan-&gt;x = ths-&gt;x;
00533   ths-&gt;direct_plan-&gt;f = ths-&gt;f;
00534   ths-&gt;F = ths-&gt;direct_plan-&gt;f_hat;
00535 }
00536 
00537 <span class="keywordtype">void</span> <a class="code" href="group__nnfft.html#ga1">nnfft_init_guru</a>(<a class="code" href="structnnfft__plan.html">nnfft_plan</a> *ths, <span class="keywordtype">int</span> d, <span class="keywordtype">int</span> N_total, <span class="keywordtype">int</span> M_total, <span class="keywordtype">int</span> *N, <span class="keywordtype">int</span> *N1,
<a name="l00538"></a><a class="code" href="group__nnfft.html#ga1">00538</a>                         <span class="keywordtype">int</span> m, <span class="keywordtype">unsigned</span> nnfft_flags)
00539 {
00540   <span class="keywordtype">int</span> t;                             
00542   <span class="keywordtype">unsigned</span> nfft_flags;
00543   <span class="keywordtype">unsigned</span> fftw_flags;
00544   
00545   ths-&gt;d= d;
00546   ths-&gt;M_total= M_total;  
00547   ths-&gt;N_total= N_total;
00548   ths-&gt;m= m;
00549   ths-&gt;nnfft_flags= nnfft_flags;
00550   fftw_flags= FFTW_ESTIMATE| FFTW_DESTROY_INPUT;
00551   nfft_flags= <a class="code" href="group__nfft.html#ga16">PRE_PHI_HUT</a>| <a class="code" href="group__nfft.html#ga23">MALLOC_F_HAT</a>| <a class="code" href="group__nfft.html#ga26">FFTW_INIT</a>| <a class="code" href="group__nfft.html#ga25">FFT_OUT_OF_PLACE</a>;
00552   
00553   <span class="keywordflow">if</span>(ths-&gt;nnfft_flags &amp; <a class="code" href="group__nfft.html#ga20">PRE_PSI</a>)
00554     nfft_flags = nfft_flags | <a class="code" href="group__nfft.html#ga20">PRE_PSI</a>;
00555     
00556   <span class="keywordflow">if</span>(ths-&gt;nnfft_flags &amp; <a class="code" href="group__nfft.html#ga21">PRE_FULL_PSI</a>)
00557     nfft_flags = nfft_flags | <a class="code" href="group__nfft.html#ga21">PRE_FULL_PSI</a>;
00558     
00559   <span class="keywordflow">if</span>(ths-&gt;nnfft_flags &amp; <a class="code" href="group__nfft.html#ga18">PRE_LIN_PSI</a>)
00560     nfft_flags = nfft_flags | <a class="code" href="group__nfft.html#ga18">PRE_LIN_PSI</a>;
00561   
00562   ths-&gt;N = (<span class="keywordtype">int</span>*) fftw_malloc(ths-&gt;d*<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00563   ths-&gt;N1 = (<span class="keywordtype">int</span>*) fftw_malloc(ths-&gt;d*<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00564   
00565   <span class="keywordflow">for</span>(t=0; t&lt;d; t++) {
00566     ths-&gt;N[t] = N[t];
00567     ths-&gt;N1[t] = N1[t];    
00568   }
00569   nnfft_init_help(ths,m,nfft_flags,fftw_flags);  
00570 }
00571 
00572 <span class="keywordtype">void</span> <a class="code" href="group__nnfft.html#ga0">nnfft_init</a>(<a class="code" href="structnnfft__plan.html">nnfft_plan</a> *ths, <span class="keywordtype">int</span> d, <span class="keywordtype">int</span> N_total, <span class="keywordtype">int</span> M_total, <span class="keywordtype">int</span> *N)
<a name="l00573"></a><a class="code" href="group__nnfft.html#ga0">00573</a> {
00574   <span class="keywordtype">int</span> t;                            
00576   <span class="keywordtype">unsigned</span> nfft_flags;
00577   <span class="keywordtype">unsigned</span> fftw_flags;
00578 
00579   ths-&gt;d = d;
00580   ths-&gt;M_total = M_total;
00581   ths-&gt;N_total = N_total;
00582   
00583   <span class="comment">/* m should be greater to get the same accuracy as the nfft */</span>
00584   WINDOW_HELP_ESTIMATE_m;
00585   
00586   ths-&gt;N = (<span class="keywordtype">int</span>*) fftw_malloc(ths-&gt;d*<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));  
00587   ths-&gt;N1 = (<span class="keywordtype">int</span>*) fftw_malloc(ths-&gt;d*<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00588   
00589   <span class="keywordflow">for</span>(t=0; t&lt;d; t++) {
00590     ths-&gt;N[t] = N[t];
00591 
00592     <span class="comment">/* the standard oversampling factor in the nnfft is 1.5 */</span>
00593     ths-&gt;N1[t] = ceil(1.5*ths-&gt;N[t]);
00594     
00595     <span class="comment">/* N1 should be even */</span>
00596     <span class="keywordflow">if</span>(ths-&gt;N1[t]%2 != 0)
00597       ths-&gt;N1[t] = ths-&gt;N1[t] +1;
00598   }
00599   ths-&gt;nnfft_flags=<a class="code" href="group__nfft.html#ga20">PRE_PSI</a>| <a class="code" href="group__nfft.html#ga16">PRE_PHI_HUT</a>| <a class="code" href="group__nfft.html#ga22">MALLOC_X</a>| <a class="code" href="group__nnfft.html#ga11">MALLOC_V</a>| <a class="code" href="group__nfft.html#ga23">MALLOC_F_HAT</a>| <a class="code" href="group__nfft.html#ga24">MALLOC_F</a>;
00600   nfft_flags= <a class="code" href="group__nfft.html#ga20">PRE_PSI</a>| <a class="code" href="group__nfft.html#ga16">PRE_PHI_HUT</a>| <a class="code" href="group__nfft.html#ga23">MALLOC_F_HAT</a>| <a class="code" href="group__nfft.html#ga26">FFTW_INIT</a>| <a class="code" href="group__nfft.html#ga25">FFT_OUT_OF_PLACE</a>;
00601   
00602   fftw_flags= FFTW_ESTIMATE| FFTW_DESTROY_INPUT;
00603   
00604   nnfft_init_help(ths,ths-&gt;m,nfft_flags,fftw_flags);    
00605 }
00606 
00607 <span class="keywordtype">void</span> <a class="code" href="group__nnfft.html#ga10">nnfft_finalize</a>(<a class="code" href="structnnfft__plan.html">nnfft_plan</a> *ths)
<a name="l00608"></a><a class="code" href="group__nnfft.html#ga10">00608</a> {
00609   <a class="code" href="group__nfft.html#ga15">nfft_finalize</a>(ths-&gt;direct_plan);
00610   
00611   free(ths-&gt;direct_plan);
00612 
00613   free(ths-&gt;aN1);
00614   free(ths-&gt;N);
00615   free(ths-&gt;N1);
00616 
00617   <span class="keywordflow">if</span>(ths-&gt;nnfft_flags &amp; <a class="code" href="group__nfft.html#ga21">PRE_FULL_PSI</a>)
00618     {
00619       fftw_free(ths-&gt;psi_index_g);
00620       fftw_free(ths-&gt;psi_index_f);
00621       fftw_free(ths-&gt;psi);
00622     }
00623   
00624   <span class="keywordflow">if</span>(ths-&gt;nnfft_flags &amp; <a class="code" href="group__nfft.html#ga20">PRE_PSI</a>)
00625     fftw_free(ths-&gt;psi);
00626 
00627   <span class="keywordflow">if</span>(ths-&gt;nnfft_flags &amp; <a class="code" href="group__nfft.html#ga18">PRE_LIN_PSI</a>)
00628     fftw_free(ths-&gt;psi);
00629       
00630       
00631   <span class="keywordflow">if</span>(ths-&gt;nnfft_flags &amp; <a class="code" href="group__nfft.html#ga16">PRE_PHI_HUT</a>)
00632     fftw_free(ths-&gt;c_phi_inv);
00633   
00634   <span class="keywordflow">if</span>(ths-&gt;nnfft_flags &amp; <a class="code" href="group__nfft.html#ga24">MALLOC_F</a>)
00635     fftw_free(ths-&gt;f);
00636 
00637   <span class="keywordflow">if</span>(ths-&gt;nnfft_flags &amp; <a class="code" href="group__nfft.html#ga23">MALLOC_F_HAT</a>)
00638     fftw_free(ths-&gt;f_hat);
00639 
00640   <span class="keywordflow">if</span>(ths-&gt;nnfft_flags &amp; <a class="code" href="group__nfft.html#ga22">MALLOC_X</a>)
00641     fftw_free(ths-&gt;x);
00642     
00643   <span class="keywordflow">if</span>(ths-&gt;nnfft_flags &amp; <a class="code" href="group__nnfft.html#ga11">MALLOC_V</a>)
00644     fftw_free(ths-&gt;v);
00645 }
</pre></div>    <hr size="1"/>
    Generated on 22 Jan 2007 by Doxygen 1.4.1
  </body>
</html>
