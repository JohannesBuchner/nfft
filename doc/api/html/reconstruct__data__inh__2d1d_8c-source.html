<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1"/>
    <title>
      NFFT 3.0.2 API Reference - NFFT: reconstruct_data_inh_2d1d.c Source File
    </title>
    <link href="doxygen.css" rel="stylesheet" type="text/css"/>
    <link href="tabs.css" rel="stylesheet" type="text/css"/>
  </head>
  <body>
    <table>
      <tr>
        <td valign="top">
          <img src="images/logo.png" alt="NFFT Logo">
        </td>
        <td align="left" valign="bottom" width="100%">
          <H1nc>3.0.2 API Reference</H1nc>
        </td>
      </tr>
    </table>  
<!-- Generated by Doxygen 1.4.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a></div>
<div class="nav">
<a class="el" href="dir_000006.html">applications</a>&nbsp;/&nbsp;<a class="el" href="dir_000007.html">mri</a>&nbsp;/&nbsp;<a class="el" href="dir_000008.html">mri2d</a></div>
<h1>reconstruct_data_inh_2d1d.c</h1><div class="fragment"><pre class="fragment">00001 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00002 <span class="preprocessor">#include &lt;math.h&gt;</span>
00003 <span class="preprocessor">#include &lt;limits.h&gt;</span>
00004 <span class="preprocessor">#include "<a class="code" href="nfft3_8h.html">nfft3.h</a>"</span>
00005 <span class="preprocessor">#include "<a class="code" href="util_8h.html">util.h</a>"</span>
00006 
00013 <span class="keywordtype">void</span> <a class="code" href="group__applications__mri2d__reconstruct__data__2d.html#ga0">reconstruct</a>(<span class="keywordtype">char</span>* filename,<span class="keywordtype">int</span> N,<span class="keywordtype">int</span> M,<span class="keywordtype">int</span> iteration , <span class="keywordtype">int</span> weight)
00014 {
00015   <span class="keywordtype">int</span> j,k,l;
00016   <span class="keywordtype">double</span> time,min_time,max_time,min_inh,max_inh;
00017   <span class="keywordtype">double</span> t,real,imag;
00018   <span class="keywordtype">double</span> w,epsilon=0.0000003;     <span class="comment">/* epsilon is a the break criterium for</span>
00019 <span class="comment">                                   the iteration */</span>;
00020   <a class="code" href="structmri__inh__2d1d__plan.html">mri_inh_2d1d_plan</a> my_plan;
00021   <a class="code" href="structimri__inh__2d1d__plan.html">imri_inh_2d1d_plan</a> my_iplan;
00022   FILE* fp,*fw,*fout_real,*fout_imag,*finh,*ftime;
00023   <span class="keywordtype">int</span> my_N[3],my_n[3];
00024   <span class="keywordtype">int</span> flags = <a class="code" href="group__nfft.html#ga16">PRE_PHI_HUT</a>| <a class="code" href="group__nfft.html#ga20">PRE_PSI</a> |<a class="code" href="group__nfft.html#ga22">MALLOC_X</a>| <a class="code" href="group__nfft.html#ga23">MALLOC_F_HAT</a>|
00025                       <a class="code" href="group__nfft.html#ga24">MALLOC_F</a>| <a class="code" href="group__nfft.html#ga26">FFTW_INIT</a>| <a class="code" href="group__nfft.html#ga25">FFT_OUT_OF_PLACE</a>;
00026   <span class="keywordtype">unsigned</span> infft_flags = <a class="code" href="group__solver.html#ga37">CGNR</a> | <a class="code" href="group__solver.html#ga41">PRECOMPUTE_DAMP</a>;
00027 
00028   <span class="keywordtype">double</span> Ts;
00029   <span class="keywordtype">double</span> W,T;
00030   <span class="keywordtype">int</span> N3;
00031   <span class="keywordtype">int</span> m=2;
00032   <span class="keywordtype">double</span> sigma = 1.25;
00033 
00034   ftime=fopen(<span class="stringliteral">"readout_time.dat"</span>,<span class="stringliteral">"r"</span>);
00035   finh=fopen(<span class="stringliteral">"inh.dat"</span>,<span class="stringliteral">"r"</span>);
00036 
00037   min_time=INT_MAX; max_time=INT_MIN;
00038   <span class="keywordflow">for</span>(j=0;j&lt;M;j++)
00039   {
00040     fscanf(ftime,<span class="stringliteral">"%le "</span>,&amp;time);
00041     <span class="keywordflow">if</span>(time&lt;min_time)
00042       min_time = time;
00043     <span class="keywordflow">if</span>(time&gt;max_time)
00044       max_time = time;
00045   }
00046   
00047   fclose(ftime);
00048   
00049   Ts=(min_time+max_time)/2.0;
00050 
00051 
00052   min_inh=INT_MAX; max_inh=INT_MIN;
00053   <span class="keywordflow">for</span>(j=0;j&lt;N*N;j++)
00054   {
00055     fscanf(finh,<span class="stringliteral">"%le "</span>,&amp;w);
00056     <span class="keywordflow">if</span>(w&lt;min_inh)
00057       min_inh = w;
00058     <span class="keywordflow">if</span>(w&gt;max_inh)
00059       max_inh = w;
00060   }
00061   fclose(finh);
00062 
00063   N3=ceil((<a class="code" href="group__nfftutil.html#ga58">NFFT_MAX</a>(fabs(min_inh),fabs(max_inh))*(max_time-min_time)/2.0+(m)/(2*sigma))*4*sigma);
00064   <span class="comment">/* N3 has to be even */</span>
00065   <span class="keywordflow">if</span>(N3%2!=0)
00066     N3++;
00067   
00068   T=((max_time-min_time)/2.0)/(0.5-((double) (m))/N3);
00069   W=N3/T;
00070 
00071   my_N[0]=N; my_n[0]=ceil(N*sigma);
00072   my_N[1]=N; my_n[1]=ceil(N*sigma);
00073   my_N[2]=N3; my_n[2]=N3;
00074   
00075   <span class="comment">/* initialise nfft */</span> 
00076   <a class="code" href="group__mri.html#ga2">mri_inh_2d1d_init_guru</a>(&amp;my_plan, my_N, M, my_n, m, sigma, flags,
00077                       FFTW_MEASURE| FFTW_DESTROY_INPUT);
00078 
00079 
00080   <span class="comment">/* precompute lin psi if set */</span>
00081   <span class="keywordflow">if</span>(my_plan.<a class="code" href="structmri__inh__2d1d__plan.html#o4">plan</a>.<a class="code" href="structnfft__plan.html#o12">nfft_flags</a> &amp; <a class="code" href="group__nfft.html#ga18">PRE_LIN_PSI</a>)
00082     <a class="code" href="group__nfft.html#ga13">nfft_precompute_lin_psi</a>(&amp;my_plan.<a class="code" href="structmri__inh__2d1d__plan.html#o4">plan</a>);
00083                       
00084   <span class="keywordflow">if</span> (weight)
00085     infft_flags = infft_flags | PRECOMPUTE_WEIGHT;
00086 
00087   <span class="comment">/* initialise my_iplan, advanced */</span>
00088   imri_inh_2d1d_init_advanced(&amp;my_iplan,&amp;my_plan, infft_flags );
00089 
00090   <span class="comment">/* get the weights */</span>
00091   if(my_iplan.flags &amp; PRECOMPUTE_WEIGHT)
00092   {
00093     fw=fopen(<span class="stringliteral">"weights.dat"</span>,<span class="stringliteral">"r"</span>);
00094     <span class="keywordflow">for</span>(j=0;j&lt;my_plan.M_total;j++)
00095     {
00096         fscanf(fw,<span class="stringliteral">"%le "</span>,&amp;my_iplan.w[j]);
00097     }
00098     fclose(fw);
00099   }
00100                       
00101   <span class="comment">/* get the damping factors */</span>
00102   <span class="keywordflow">if</span>(my_iplan.<a class="code" href="structimri__inh__2d1d__plan.html#o1">flags</a> &amp; <a class="code" href="group__solver.html#ga41">PRECOMPUTE_DAMP</a>)
00103   {
00104     <span class="keywordflow">for</span>(j=0;j&lt;N;j++){
00105       <span class="keywordflow">for</span>(k=0;k&lt;N;k++) {
00106         <span class="keywordtype">int</span> j2= j-N/2;
00107         <span class="keywordtype">int</span> k2= k-N/2;
00108         <span class="keywordtype">double</span> r=sqrt(j2*j2+k2*k2);
00109         <span class="keywordflow">if</span>(r&gt;(double) N/2) 
00110           my_iplan.<a class="code" href="structimri__inh__2d1d__plan.html#o3">w_hat</a>[j*N+k]=0.0;
00111         <span class="keywordflow">else</span>
00112           my_iplan.<a class="code" href="structimri__inh__2d1d__plan.html#o3">w_hat</a>[j*N+k]=1.0;
00113       }   
00114     }
00115   }
00116 
00117   fp=fopen(filename,<span class="stringliteral">"r"</span>);
00118   ftime=fopen(<span class="stringliteral">"readout_time.dat"</span>,<span class="stringliteral">"r"</span>);
00119 
00120   <span class="keywordflow">for</span>(j=0;j&lt;my_plan.<a class="code" href="structmri__inh__2d1d__plan.html#o1">M_total</a>;j++)
00121   {
00122     fscanf(fp,<span class="stringliteral">"%le %le %le %le"</span>,&amp;my_plan.<a class="code" href="structmri__inh__2d1d__plan.html#o4">plan</a>.<a class="code" href="structnfft__plan.html#o14">x</a>[2*j+0],&amp;my_plan.<a class="code" href="structmri__inh__2d1d__plan.html#o4">plan</a>.<a class="code" href="structnfft__plan.html#o14">x</a>[2*j+1],&amp;real,&amp;imag);
00123     my_iplan.<a class="code" href="structimri__inh__2d1d__plan.html#o4">y</a>[j]=real+I*imag;
00124     fscanf(ftime,<span class="stringliteral">"%le "</span>,&amp;my_plan.<a class="code" href="structmri__inh__2d1d__plan.html#o7">t</a>[j]);
00125 
00126     my_plan.<a class="code" href="structmri__inh__2d1d__plan.html#o7">t</a>[j] = (my_plan.<a class="code" href="structmri__inh__2d1d__plan.html#o7">t</a>[j]-Ts)/T;
00127   }
00128   fclose(fp);
00129   fclose(ftime);
00130 
00131 
00132   finh=fopen(<span class="stringliteral">"inh.dat"</span>,<span class="stringliteral">"r"</span>);
00133   <span class="keywordflow">for</span>(j=0;j&lt;N*N;j++)
00134   {
00135     fscanf(finh,<span class="stringliteral">"%le "</span>,&amp;my_plan.<a class="code" href="structmri__inh__2d1d__plan.html#o8">w</a>[j]);
00136     my_plan.<a class="code" href="structmri__inh__2d1d__plan.html#o8">w</a>[j]/=W;
00137   }
00138   fclose(finh);  
00139 
00140     
00141   <span class="keywordflow">if</span>(my_plan.<a class="code" href="structmri__inh__2d1d__plan.html#o4">plan</a>.<a class="code" href="structnfft__plan.html#o12">nfft_flags</a> &amp; <a class="code" href="group__nfft.html#ga20">PRE_PSI</a>) {
00142     <a class="code" href="group__nfft.html#ga12">nfft_precompute_psi</a>(&amp;my_plan.<a class="code" href="structmri__inh__2d1d__plan.html#o4">plan</a>);
00143   }
00144   <span class="keywordflow">if</span>(my_plan.<a class="code" href="structmri__inh__2d1d__plan.html#o4">plan</a>.<a class="code" href="structnfft__plan.html#o12">nfft_flags</a> &amp; <a class="code" href="group__nfft.html#ga21">PRE_FULL_PSI</a>) {
00145       <a class="code" href="group__nfft.html#ga11">nfft_precompute_full_psi</a>(&amp;my_plan.<a class="code" href="structmri__inh__2d1d__plan.html#o4">plan</a>);
00146   } 
00147 
00148   <span class="comment">/* init some guess */</span>
00149   <span class="keywordflow">for</span>(j=0;j&lt;my_plan.<a class="code" href="structmri__inh__2d1d__plan.html#o0">N_total</a>;j++)
00150   {
00151     my_iplan.<a class="code" href="structimri__inh__2d1d__plan.html#o5">f_hat_iter</a>[j]=0.0;
00152   }
00153  
00154   t=<a class="code" href="group__nfftutil.html#ga0">nfft_second</a>();
00155   
00156   <span class="comment">/* inverse trafo */</span>
00157   <a class="code" href="group__solver.html#ga22">imri_inh_2d1d_before_loop</a>(&amp;my_iplan);
00158   <span class="keywordflow">for</span>(l=0;l&lt;iteration;l++)
00159   {
00160     <span class="comment">/* break if dot_r_iter is smaller than epsilon*/</span>
00161     <span class="keywordflow">if</span>(my_iplan.<a class="code" href="structimri__inh__2d1d__plan.html#o12">dot_r_iter</a>&lt;epsilon)
00162     <span class="keywordflow">break</span>;
00163     fprintf(stderr,<span class="stringliteral">"%e,  %i of %i\n"</span>,sqrt(my_iplan.<a class="code" href="structimri__inh__2d1d__plan.html#o12">dot_r_iter</a>),
00164     l+1,iteration);
00165     <a class="code" href="group__solver.html#ga23">imri_inh_2d1d_loop_one_step</a>(&amp;my_iplan);
00166   }
00167 
00168   t=<a class="code" href="group__nfftutil.html#ga0">nfft_second</a>()-t;
00169 <span class="preprocessor">#ifdef HAVE_MALLINFO</span>
00170 <span class="preprocessor"></span>  fprintf(stderr,<span class="stringliteral">"time: %e seconds mem: %i \n"</span>,t,<a class="code" href="group__nfftutil.html#ga1">nfft_total_used_memory</a>());
00171 <span class="preprocessor">#else</span>
00172 <span class="preprocessor"></span>  fprintf(stderr,<span class="stringliteral">"time: %e seconds mem: mallinfo not available\n"</span>,t);
00173 <span class="preprocessor">#endif</span>
00174 <span class="preprocessor"></span>  
00175   fout_real=fopen(<span class="stringliteral">"output_real.dat"</span>,<span class="stringliteral">"w"</span>);
00176   fout_imag=fopen(<span class="stringliteral">"output_imag.dat"</span>,<span class="stringliteral">"w"</span>);
00177   
00178   <span class="keywordflow">for</span> (j=0;j&lt;N*N;j++) {
00179     <span class="comment">/* Verschiebung wieder herausrechnen */</span>
00180     my_iplan.<a class="code" href="structimri__inh__2d1d__plan.html#o5">f_hat_iter</a>[j]*=cexp(-2.0*I*PI*Ts*my_plan.<a class="code" href="structmri__inh__2d1d__plan.html#o8">w</a>[j]*W);
00181     
00182     fprintf(fout_real,<span class="stringliteral">"%le "</span>,creal(my_iplan.<a class="code" href="structimri__inh__2d1d__plan.html#o5">f_hat_iter</a>[j]));
00183     fprintf(fout_imag,<span class="stringliteral">"%le "</span>,cimag(my_iplan.<a class="code" href="structimri__inh__2d1d__plan.html#o5">f_hat_iter</a>[j]));
00184   }
00185 
00186   fclose(fout_real);
00187   fclose(fout_imag);
00188   <a class="code" href="group__solver.html#ga24">imri_inh_2d1d_finalize</a>(&amp;my_iplan);
00189   <a class="code" href="group__mri.html#ga3">mri_inh_2d1d_finalize</a>(&amp;my_plan);
00190 }
00191 
00192 
00193 <span class="keywordtype">int</span> <a class="code" href="flags_8c.html#a6">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
00194 {
00195   <span class="keywordflow">if</span> (argc &lt;= 5) {
00196 
00197     printf(<span class="stringliteral">"usage: ./reconstruct_data_inh_2d1d FILENAME N M ITER WEIGHTS\n"</span>);
00198     <span class="keywordflow">return</span> 1;
00199   }
00200   
00201   <a class="code" href="group__applications__mri2d__reconstruct__data__2d.html#ga0">reconstruct</a>(argv[1],atoi(argv[2]),atoi(argv[3]),atoi(argv[4]),atoi(argv[5]));
00202 
00203   <span class="keywordflow">return</span> 1;
00204 }
00205 <span class="comment">/* \} */</span>
</pre></div>    <hr size="1"/>
    Generated on 22 Jan 2007 by Doxygen 1.4.1
  </body>
</html>
